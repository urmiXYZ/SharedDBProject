@model List<MDUA.Entities.SalesOrderHeader>
@{
    ViewData["Title"] = "All Sales Orders";
    Layout = "_AdminLayout";
}

@section Styles {
    <link rel="stylesheet" href="~/css/orders.css" asp-append-version="true" />
}

@Html.AntiForgeryToken()

<div class="orders-wrapper">

    <div class="orders-header d-flex justify-content-between align-items-center">
        <div>
            <h2 class="fw-bold mb-0">Order List</h2>
            <div class="text-muted small">Total Orders: @(Model?.Count() ?? 0)</div>
        </div>
    </div>

    @if (ViewData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger mb-3" role="alert">
            @ViewData["ErrorMessage"]
        </div>
    }

    <div class="glass-card-fill">

        <div class="table-scroll-lock">
            <table class="table table-hover mb-0 align-middle products-table">
                <thead>
                    <tr>
                        <th style="width: 40px;"></th>
                        <th>ID</th>
                        <th>Order Type</th>
                        <th>Order Date</th>
                        <th>Net Amount</th>
                        <th class="text-success">Paid</th>
                        <th class="text-danger">Due</th>
                        <th>Status</th>
                        <th>Confirmed</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model != null && Model.Any())
                    {
                        foreach (var order in Model.OrderByDescending(o => o.OrderDate))
                        {
                            string collapseId = "collapse_" + order.Id;
                            string orderIdDisplay = order.SalesOrderId ?? order.Id.ToString();
                            string orderType = order.SalesChannelId == 1 ? "Online" : "Direct";

                            string displayStatus = order.Status == "Draft" ? "Pending" : order.Status;
                            bool isToggleDisabled = order.Status == "Cancelled" ||
                            order.Status == "Delivered" ||
                            order.Status == "Returned";

                            // ✅ REFINED LOGIC: Explicitly handle Cancelled
                            string statusBadgeClass = "bg-secondary-subtle text-dark"; // Default

                            if (order.Status == "Confirmed") statusBadgeClass = "bg-success text-white";
                            else if (order.Status == "Pending" || order.Status == "Draft") statusBadgeClass = "bg-warning text-dark";
                            else if (order.Status == "Cancelled") statusBadgeClass = "bg-danger text-white"; // Force Red
                            else if (order.Status == "Delivered") statusBadgeClass = "bg-primary text-white";

                            <tr class="accordion-toggle" style="cursor: pointer;"
                                onclick="document.getElementById('btn-@order.Id').click()">
                                <td onclick="event.stopPropagation();">
                                    <button class="btn btn-sm btn-link text-decoration-none text-dark p-0 transition-icon"
                                            type="button"
                                            id="btn-@order.Id"
                                            data-bs-toggle="collapse"
                                            data-bs-target="#@collapseId">
                                        <i class="fas fa-chevron-right"></i>
                                    </button>
                                </td>
                                <td class="fw-bold text-primary">@orderIdDisplay</td>
                                <td>@orderType</td>

                                <td class="small">
                                    <span class="utc-date" data-utc="@order.OrderDate.ToUtcString()">
                                        @FormatDate(order.OrderDate)
                                    </span>
                                </td>
                                <td class="fw-bold">Tk. @FormatAmount(order.NetAmount)</td>

                                <td class="text-success fw-bold">
                                    @if (order.PaidAmount > 0)
                                    {
                                        <span>Tk. @FormatAmount(order.PaidAmount)</span>
                                    }
                                    else
                                    {
                                        <span class="text-muted small">-</span>
                                    }
                                </td>

                                <td class="text-danger fw-bold">
                                    @if (order.DueAmount > 0)
                                    {
                                        <span>Tk. @FormatAmount(order.DueAmount)</span>
                                    }
                                    else
                                    {
                                        <span class="badge bg-success-subtle text-success border border-success-subtle">Paid</span>
                                    }
                                </td>

                                <td>
                                    @* Added id="status-badge-@order.Id" so JS can find it *@
                                    <span id="status-badge-@order.Id" class="badge @statusBadgeClass">@displayStatus</span>
                                </td>                                <td onclick="event.stopPropagation();">
                                    <div class="form-check form-switch">
                                        <input class="form-check-input confirm-toggle" type="checkbox"
                                               id="toggle-@order.Id"
                                               data-id="@order.Id"
                                               @(order.Confirmed ? "checked" : "")
                                               @(isToggleDisabled ? "disabled" : "")>  @* ✅ NEW: Apply disabled attribute *@
                                    </div>
                                </td>
                            </tr>

                            <tr class="collapse bg-light shadow-sm" id="@collapseId">
                                <td colspan="7" class="p-3 bg-light">
                                    <div class="d-flex align-items-center gap-3 ps-3">
                                        <span class="text-uppercase small fw-bold text-muted">Actions:</span>

                                        @{
                                            // ✅ CONSTRUCT FULL ADDRESS STRING
                                            // Format: Country, Divison, City, Thana, SubOffice, Street, PostalCode
                                            var addrParts = new List<string>();
                                            if (!string.IsNullOrWhiteSpace(order.Country)) addrParts.Add(order.Country);
                                            if (!string.IsNullOrWhiteSpace(order.Divison)) addrParts.Add(order.Divison);
                                            if (!string.IsNullOrWhiteSpace(order.City)) addrParts.Add(order.City);
                                            if (!string.IsNullOrWhiteSpace(order.Thana)) addrParts.Add(order.Thana);
                                            if (!string.IsNullOrWhiteSpace(order.SubOffice)) addrParts.Add(order.SubOffice);
                                            if (!string.IsNullOrWhiteSpace(order.Street)) addrParts.Add(order.Street);
                                            if (!string.IsNullOrWhiteSpace(order.PostalCode)) addrParts.Add(order.PostalCode);

                                            string fullAddress = string.Join(", ", addrParts);
                                        }

                                        <button type="button" class="btn btn-sm btn-white border shadow-sm"
                                                data-bs-toggle="modal" data-bs-target="#detailsModal"
                                                data-id="@orderIdDisplay"
                                                data-status="@displayStatus"
                                                data-type="@orderType"
                                                @* --- Customer & Address IDs + Details --- *@
                                                data-cust-id="@order.CompanyCustomerId"
                                                data-cust-name="@order.CustomerName" @* ✅ NEW *@
                                                data-cust-phone="@(order.CustomerPhone ?? "N/A")"
                                                data-addr-id="@(order.AddressId == 0 ? "N/A" : order.AddressId.ToString())"
                                                data-full-addr="@fullAddress" @* ✅ NEW *@
                                                data-total="@FormatAmount(order.TotalAmount)"
                                                data-net="@FormatAmount(order.NetAmount)"
                                                data-discount="@FormatAmount(order.TotalAmount - order.NetAmount)"
                                                data-created-by="@(order.CreatedBy ?? "System")"
                                                data-created-at="@order.CreatedAt.ToUtcString()"
                                                data-updated-at="@order.UpdatedAt.ToUtcString()"
                                                data-updated-by="@(order.UpdatedBy ?? "-")"
                                                data-ip="@(order.IPAddress ?? "N/A")"
                                                data-session="@(order.SessionId ?? "N/A")">
                                            <i class="fas fa-eye text-primary me-1"></i> View Details
                                        </button>

                                        <button type="button" class="btn btn-sm btn-white border shadow-sm"
                                                onclick="openAdvanceModal(this)"
                                                data-order-id="@order.Id"
                                                data-order-ref="@orderIdDisplay"
                                                data-cust-id="@order.CompanyCustomerId"
                                                data-net="@FormatRaw(order.NetAmount)"
                                                data-paid="@FormatRaw(order.PaidAmount)"
                                                data-delivery="@FormatRaw(order.DeliveryCharge)"
                                                @* ✅ NEW: Passing Product Price and Discount *@
                                                data-product-price="@FormatRaw(order.TotalAmount - order.DeliveryCharge)"
                                                data-discount="@FormatRaw(order.DiscountAmount)">

                                            <i class="fas fa-money-bill-wave text-success me-1"></i> Add Advance Payment
                                        </button>
                                        @if (order.Status != "Cancelled" && order.Status != "Delivered" && order.Status != "Returned" && order.Status != "Confirmed")
                                        {
                                            <button type="button" class="btn btn-sm btn-white border shadow-sm text-danger"
                                                    id="btn-cancel-@order.Id" @* ✅ NEW ID *@
                                                    onclick="cancelOrder(@order.Id, '@orderIdDisplay')"
                                                    title="Cancel this order">
                                                <i class="fas fa-times-circle me-1"></i> Cancel
                                            </button>
                                        }
                                    </div>
                                </td>
                            </tr>
                        }
                    }
                </tbody>
            </table>

            <style>
                .transition-icon {
                    transition: transform 0.2s ease;
                }

                [aria-expanded="true"] .transition-icon {
                    transform: rotate(90deg);
                }

                .shadow-inset {
                    box-shadow: inset 0 4px 6px -4px rgba(0,0,0,0.1);
                }

                .modal-backdrop {
                    z-index: 1040 !important;
                }

                .modal {
                    z-index: 1050 !important;
                }

                .modal-dialog {
                    z-index: 1060 !important;
                }
            </style>
        </div>
    </div>

</div>
<div class="modal fade" id="advanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-light">
                <h5 class="modal-title fs-6 fw-bold">Add Advance Payment</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-4">
                <form id="advanceForm">
                    <input type="hidden" id="adv_orderId" name="OrderId" />
                    <input type="hidden" id="adv_customerId" name="CustomerId" />
                    <input type="hidden" id="adv_orderRef" name="TransactionReference" />

                    @* ✅ NEW ROW: Product Price & Discount *@
                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Product Price</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="text" id="adv_productPrice" class="form-control fw-bold bg-light" readonly disabled />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Discount</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0 text-danger">- Tk</span>
                                <input type="text" id="adv_discount" class="form-control fw-bold text-danger bg-light" readonly disabled />
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small text-muted">Total Payable (Inc. Delivery)</label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="text" id="adv_netAmount" class="form-control fw-bold bg-white" readonly />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted">Delivery Charge (Editable) <span class="text-danger">*</span></label>
                            <div class="input-group input-group-sm">
                                <span class="input-group-text bg-light border-0">Tk</span>
                                <input type="number" id="adv_delivery" class="form-control fw-bold" value="0" />
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3 p-2 bg-light rounded border mx-0">
                        <div class="col-6">
                            <label class="form-label small text-muted mb-0">Already Paid</label>
                            <div class="fw-bold text-success fs-6">
                                Tk <span id="adv_displayPaid">0.00</span>
                                <input type="hidden" id="adv_alreadyPaid" value="0" />
                            </div>
                        </div>
                        <div class="col-6">
                            <label class="form-label small text-muted mb-0">Current Due</label>
                            <div class="fw-bold text-danger fs-6">
                                Tk <span id="adv_displayCurrentDue">0.00</span>
                            </div>
                        </div>
                    </div>

                    <div class="row g-3 mb-3">
                        <div class="col-6">
                            <label class="form-label small fw-bold">Payment Method <span class="text-danger">*</span></label>
                            <select id="adv_paymentMethod" name="PaymentMethodId" class="form-select form-select-sm" required>
                                @if (ViewBag.PaymentMethods != null)
                                {
                                    foreach (var pm in ViewBag.PaymentMethods)
                                    {
                                        <option value="@pm.PaymentMethodId">@pm.MethodName</option>
                                    }
                                }
                                else
                                {
                                    <option value="1">Cash</option>
                                }
                            </select>
                        </div>
                        <div class="col-6">
                            <label class="form-label small fw-bold">Payment Type <span class="text-danger">*</span></label>
                            <select id="adv_paymentType" name="PaymentType" class="form-select form-select-sm">
                                <option value="Advance">Advance (Partial)</option>
                                <option value="Sale">Sale (Full Payment)</option>
                            </select>
                        </div>
                    </div>

                    <hr class="text-muted my-2 opacity-25">

                    <div class="mb-3">
                        <label class="form-label fw-bold text-success">Amount Paying Now <span class="text-danger">*</span></label>
                        <div class="input-group has-validation">
                            <span class="input-group-text bg-success text-white">Tk</span>
                            <input type="number" id="adv_paidAmount" name="Amount" class="form-control fw-bold fs-5" placeholder="0.00" required />
                            <div id="adv_amountError" class="invalid-feedback fw-bold">
                                Amount cannot exceed the Current Due.
                            </div>
                        </div>
                    </div>

                    <div class="mb-3 p-2 bg-danger-subtle rounded border border-danger-subtle d-flex justify-content-between align-items-center">
                        <span class="text-danger fw-medium small">Balance After Payment:</span>
                        <span class="text-danger fw-bold fs-5">Tk <span id="adv_dueAmount">0.00</span></span>
                    </div>

                    <div class="mb-3">
                        @* ✅ ADDED: ID 'adv_note_star' and class 'd-none' *@
                        <label class="form-label small">Note / Remarks <span id="adv_note_star" class="text-danger d-none">*</span></label>
                        <textarea id="adv_note" name="Notes" class="form-control form-control-sm" rows="2" placeholder="e.g. Bkash Trx ID..."></textarea>
                    </div>

                    <button type="submit" id="adv_submitBtn" class="btn btn-success w-100 fw-medium">Save Advance Payment</button>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="detailsModal" tabindex="-1" aria-labelledby="detailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable order-details-modal">
        <div class="modal-content">
            <div class="modal-header modal-header-soft">
                <h5 class="modal-title" id="detailsModalLabel">Order <span id="m-id" class="text-primary"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="info-section status-section">
                    <div class="section-header">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path d="M10.97 4.97a.235.235 0 0 0-.02.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-1.071-1.05z" />
                        </svg>
                        <span>Order Status</span>
                    </div>
                    <div class="section-content">
                        <h4 id="m-status" class="mb-0"></h4>
                    </div>
                </div>
                <div class="info-section">
                    <div class="section-header">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M3 14s-1 0-1-1 1-4 6-4 6 3 6 4-1 1-1 1H3zm5-6a3 3 0 1 0 0-6 3 3 0 0 0 0 6z" />
                        </svg>
                        <span>General Information</span>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Order Type</span>
                                <span class="info-value" id="m-type"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Customer ID</span>
                                <span class="info-value" id="m-cust-id"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Phone Number</span>
                                <span class="info-value" id="m-cust-phone"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Address ID</span>
                                <span class="info-value" id="m-addr-id"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-section financial-section">
                    <div class="section-header">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M4 10.781c.148 1.667 1.513 2.85 3.591 3.003V15h1.043v-1.216c2.27-.179 3.678-1.438 3.678-3.3 0-1.59-.947-2.51-2.956-3.028l-.722-.187V3.467c1.122.11 1.879.714 2.07 1.616h1.47c-.166-1.6-1.54-2.748-3.54-2.875V1H7.591v1.233c-1.939.23-3.27 1.472-3.27 3.156 0 1.454.966 2.483 2.661 2.917l.61.162v4.031c-1.149-.17-1.94-.8-2.131-1.718H4zm3.391-3.836c-1.043-.263-1.6-.825-1.6-1.616 0-.944.704-1.641 1.8-1.828v3.495l-.2-.05zm1.591 1.872c1.287.323 1.852.859 1.852 1.769 0 1.097-.826 1.828-2.2 1.939V8.73l.348.086z" />
                        </svg>
                        <span>Financial Breakdown</span>
                    </div>
                    <div class="section-content">
                        <div class="finance-grid">
                            <div class="finance-item">
                                <span class="finance-label">Total Amount</span>
                                <span class="finance-value">Tk. <span id="m-total"></span></span>
                            </div>
                            <div class="finance-item discount">
                                <span class="finance-label">Discount</span>
                                <span class="finance-value">- Tk. <span id="m-discount"></span></span>
                            </div>
                            <div class="finance-item net">
                                <span class="finance-label">Net Amount</span>
                                <span class="finance-value">Tk. <span id="m-net"></span></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-section">
                    <div class="section-header">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 16a2 2 0 0 0 2-2H6a2 2 0 0 0 2 2zM8 1.918l-.797.161A4.002 4.002 0 0 0 4 6c0 .628-.134 2.197-.459 3.742-.16.767-.376 1.566-.663 2.258h10.244c-.287-.692-.502-1.49-.663-2.258C12.134 8.197 12 6.628 12 6a4.002 4.002 0 0 0-3.203-3.92L8 1.917zM14.22 12c.223.447.481.801.78 1H1c.299-.199.557-.553.78-1C2.68 10.2 3 6.88 3 6c0-2.42 1.72-4.44 4.005-4.901a1 1 0 1 1 1.99 0A5.002 5.002 0 0 1 13 6c0 .88.32 4.2 1.22 6z" />
                        </svg>
                        <span>System & Audit</span>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">Created By</span>
                                <span class="info-value" id="m-created-by"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Created At</span>
                                <span class="info-value" id="m-created-at"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Updated By</span>
                                <span class="info-value" id="m-updated-by"></span>
                            </div>
                            <div class="info-item">
                                <span class="info-label">Updated At</span>
                                <span class="info-value" id="m-updated-at"></span>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="info-section">
                    <div class="section-header">
                        <svg width="16" height="16" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2V4zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1H2zm13 2.383-4.708 2.825L15 11.105V5.383zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741zM1 11.105l4.708-2.897L1 5.383v5.722z" />
                        </svg>
                        <span>Technical Data</span>
                    </div>
                    <div class="section-content">
                        <div class="info-grid">
                            <div class="info-item">
                                <span class="info-label">IP Address</span>
                                <span class="info-value code" id="m-ip"></span>
                            </div>
                            <div class="info-item full-width">
                                <span class="info-label">Session ID</span>
                                <span class="info-value code" id="m-session"></span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/order-details.js" asp-append-version="true"></script>
    <script src="~/js/order-actions.js" asp-append-version="true"></script>
}

@functions {
    public string FormatDate(DateTime? date)
    {
        if (!date.HasValue || date.Value == DateTime.MinValue) return "N/A";
        return date.Value.ToString("MMM dd, yyyy");
    }

    public string FormatAmount(decimal? amount)
    {
        if (!amount.HasValue || amount.Value == 0M) return "0.00";
        return amount.Value.ToString("N2");
    }

    public string FormatRaw(decimal? amount)
    {
        if (!amount.HasValue) return "0";
        return amount.Value.ToString("0.##");
    }
}