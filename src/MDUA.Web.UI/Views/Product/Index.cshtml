@model MDUA.Entities.Product
@using System.Text.RegularExpressions
@{
    ViewData["Title"] = Model.ProductName ?? "Combo Offer";
    Layout = null;
    // 1. Extract dynamic delivery charges safely
    int dhakaCharge = Model.DeliveryCharges?.GetValueOrDefault("dhaka", 0) ?? 0;
    int outsideCharge = Model.DeliveryCharges?.GetValueOrDefault("outside", 0) ?? 0;
    decimal basePrice = Model.BasePrice ?? 0;
    // 2. Identify Primary Image for Fallback
    var primaryImageObject = Model.Images?.FirstOrDefault(i => i.IsPrimary) ?? Model.Images?.FirstOrDefault();
    string mainImageUrl = (primaryImageObject != null && !string.IsNullOrEmpty(primaryImageObject.ImageUrl))
        ? primaryImageObject.ImageUrl
        : null;
    string productVideoUrl = Model.ProductVideoUrl;
    var galleryImages = Model.Images?
         .Where(i => !string.IsNullOrEmpty(i.ImageUrl) && i.ImageUrl != mainImageUrl)
         .ToList();

}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.ProductName | @(Model.CompanyName ?? "Shop")</title>
    <link rel="stylesheet" href="~/css/combo.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
</head>
<body>
    <header class="header">
        <div class="container">
            <img src="@Url.Content(string.IsNullOrEmpty(Model.CompanyLogoUrl) ? "~/images/logo.jpg" : $"~{Model.CompanyLogoUrl}")"
                 alt="@(Model.CompanyName ?? "Company") Logo"
                 class="logo"
                 onerror="this.onerror=null; this.src='/images/logo.jpg';" />
        </div>
    </header>

    <div class="container">
        <section class="combo-info card">
            <h1>🎉 @Model.ProductName 🎉</h1>
            <div class="product-description-content">
                @Html.Raw(Model.Description)
            </div>
            <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap;">
                <a href="#order" class="btn combo-btn">Order Now</a>
                <button id="open-status-modal" class="btn status-btn">Track My Order</button>
            </div>
        </section>

        <section class="scarcity-section">
            <p class="stock-text">@Model.ScarcityMessage</p>
            <div class="stock-bar">
                <div class="stock-fill" style="width:@Model.StockBarPercentage.ToString("0")%;"></div>
            </div>
            <p class="hurry-text">Hurry! Selling fast 🚀</p>
        </section>

        <section class="price-section">
            <div class="card" style="display: inline-block; padding: 1.5rem 3rem;">
                <p class="price">
                    Tk. @Model.SellingPrice.ToString("N0")

                    @* Only show the old cut price if it is higher than the selling price *@
                    @if (basePrice > Model.SellingPrice)
                    {
                        <span class="old-price">Tk. @basePrice.ToString("N0")</span>
                    }
                </p>
                <p class="offer-text">💰 Cash on delivery available</p>
            </div>
        </section>
        @if (!string.IsNullOrEmpty(mainImageUrl))
        {
            <section class="product-image">
                <img src="@Url.Content($"~{mainImageUrl}")"
                     alt="@Model.ProductName"
                     class="combo main-img"
                     id="main-product-img"
                     loading="eager"
                     onerror="this.closest('.product-image').style.display='none'" />
            </section>
        }

        @if (galleryImages != null && galleryImages.Count > 0)
        {
            <section class="product-gallery card">
                <h2>Product Gallery</h2>
                <div class="carousel">
                    <button class="prev" onclick="changeSlide(-1)">&#10094;</button>

                    <div class="slides">
                        @foreach (var img in galleryImages)
                        {
                            string slideImg = FixPath(img.ImageUrl);

                            <img src="@Url.Content($"~{slideImg}")"
                                 alt="@Model.ProductName Gallery"
                                 class="slide"
                                 loading="lazy"
                                 @* If this specific image fails, hide it immediately *@
                                 onerror="this.style.display='none'" />
                        }
                    </div>

                    <button class="next" onclick="changeSlide(1)">&#10095;</button>
                </div>
            </section>
        }
        @* YOUTUBE VIDEO SECTION *@
        @* VIDEO SECTION *@
        @* VIDEO SECTION *@
        @* VIDEO SECTION *@
        @if (!string.IsNullOrEmpty(productVideoUrl))
        {
            <section class="video-section card" style="text-align: center; padding: 20px; max-width: 800px; margin: 20px auto;">
                <h2 style="margin-bottom: 15px;">Product Video</h2>

                @{
                    string embedUrl = GetEmbedUrl(productVideoUrl);
                    bool isVertical = IsVerticalVideo(productVideoUrl);

                    // IF VERTICAL: Use 177.78% (9:16)
                    // IF HORIZONTAL: Use 56.25% (16:9)
                    string paddingPercentage = isVertical ? "177.78%" : "56.25%";
                    string containerClass = isVertical ? "video-container vertical" : "video-container";
                }

                @if (!string.IsNullOrEmpty(embedUrl))
                {
                    <div class="@containerClass"
                         style="position: relative; width: 100%; padding-top: @paddingPercentage; background: #000; border-radius: 8px; overflow: hidden; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">

                        <iframe src="@Html.Raw(embedUrl)"
                                title="Product Video"
                                frameborder="0"
                                allow="autoplay; clipboard-write; encrypted-media; picture-in-picture; web-share"
                                allowfullscreen
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%;">
                        </iframe>
                    </div>
                }
            </section>
        }

        @if (Model.Specifications != null && Model.Specifications.Count > 0)
        {
            <section class="description card">
                <h2>Product Details</h2>
                @foreach (var spec in Model.Specifications)
                {
                    <div class="detail-row">
                        <span class="detail-icon">@GetAttributeIcon(spec.Key)</span>
                        <p>
                            <strong>@spec.Key:</strong>
                            @string.Join(", ", spec.Value)
                        </p>
                    </div>
                }
            </section>
        }
        @if (Model.Reviews != null && Model.Reviews.Count > 0)
        {
            <section class="testimonials card">
                <h2>What Our Customers Say</h2>
                <div class="reviews">
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="review">
                            <p class="review-text">"@review.ReviewText"</p>
                            <p class="reviewer">– @review.CustomerName</p>
                        </div>
                    }
                </div>
            </section>
        }

        <section id="order" class="order-section">
            <h2>Place Your Order</h2>
            <div class="order-container">

                <!-- LEFT: BILLING FORM (Order 1 on mobile) -->
                <div class="billing">
                    <form id="order-form" novalidate>
                        <input type="hidden" id="product-id" value="@Model.Id" />
                        <input type="hidden" id="selected-variant-id" name="ProductVariantId" required />

                        <div class="variant-selection-area">
                            @{
                                var dynamicAttributes = new Dictionary<string, List<string>>();
                                if (Model.Specifications != null)
                                {
                                    foreach (var spec in Model.Specifications)
                                    {
                                        dynamicAttributes[spec.Key] = spec.Value;
                                    }
                                }

                            }

                            @if (dynamicAttributes.Any())
                            {
                                foreach (var attr in dynamicAttributes)
                                {
                                    var attributeName = attr.Key;
                                    var attributeValues = attr.Value;
                                    if (attributeValues != null && attributeValues.Any())
                                    {
                                        <label class="section-label">Select @attributeName:</label>
                                        <div class="variant-chips-container" id="container-@attributeName.ToLower().Replace(" ", "-")">
                                            @foreach (var val in attributeValues)
                                            {
                                                <div class="variant-chip"
                                                     data-attribute="@attributeName"
                                                     data-value="@val">
                                                    @val
                                                </div>
                                            }
                                        </div>
                                    }
                                }
                            }
                            <div id="variant-info" style="display:none; margin-top: 15px; margin-bottom: 15px; padding: 8px 12px; background-color: #f0fdf4; border-radius: 6px; border: 1px solid #bbf7d0;">
                                <div id="stock-message" style="font-family: 'Inter', sans-serif;"></div>
                            </div>
                        </div>

                        <div id="mobile-order-variant-image-holder">
                            <img id="mobile-order-variant-image"
                                 src="@FixPath(mainImageUrl)"
                                 alt="Selected Variant"
                                 style="width: 100%; height: 200px; object-fit: contain;"
                                 onerror="this.style.display='none'" />
                        </div>



                        <label>Phone Number <span class="required-star">*</span></label>
                        <div class="input-group">
                            <input type="tel" id="customerPhone" name="CustomerPhone" placeholder="017XXXXXXXX" required />
                            <div id="phone-status" class="status-text" style="font-size: 0.85rem; margin-top: 4px;"></div>
                        </div>

                        <label>Full Name <span class="required-star">*</span></label>
                        <input type="text" id="customerName" name="CustomerName" required />

                        <label>Email (Optional)</label>
                        <input type="email" id="customerEmail" name="CustomerEmail" placeholder="email@example.com" />
                        <div id="email-status" class="status-text" style="font-size: 0.85rem; margin-top: 4px;"></div>

                        <div class="address-section">
                            <label>Postal Code <span class="required-star">*</span></label>
                            <input type="text" name="PostalCode" placeholder="1212" required />

                            <label>Street Address <span class="required-star">*</span></label>
                            <textarea name="Street" placeholder="House No, Road No, Area..." rows="2" required></textarea>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Division <span class="required-star">*</span></label>
                                    <select id="division-select" name="Divison" required>
                                        <option value="">Select Division</option>
                                    </select>
                                </div>
                                <div>
                                    <label>District <span class="required-star">*</span></label>
                                    <select id="district-select" name="City" disabled required>
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                            </div>

                            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                                <div>
                                    <label>Thana <span class="required-star">*</span></label>
                                    <select id="thana-select" name="Thana" disabled required>
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                                <div>
                                    <label>Sub-Office <span class="required-star">*</span></label>
                                    <select id="suboffice-select" name="SubOffice" disabled required>
                                        <option value="">Select...</option>
                                    </select>
                                </div>
                            </div>

                            <input type="hidden" name="ZipCOde" />
                            <input type="hidden" name="Country" value="Bangladesh" />
                            <input type="hidden" name="AddressType" value="Shipping" />
                        </div>

                        <div class="qty-row">
                            <label style="margin:0;">Quantity</label>
                            <div style="text-align: right;">
                                <div class="quantity-wrapper">
                                    <button type="button" id="decrease">-</button>
                                    <input type="number" id="quantity" name="OrderQuantity" value="1" min="1" readonly />
                                    <button type="button" id="increase">+</button>
                                </div>
                                <small id="stock-error-message" class="text-danger"></small>
                            </div>
                        </div>
                    </form>
                </div>

                <!-- RIGHT: ORDER SUMMARY (Order 2 on mobile) -->
                <div class="order-summary">
                    <div id="order-variant-image-holder">
                        <img id="order-variant-image"
                             src="@FixPath(mainImageUrl)"
                             alt="Selected Variant"
                             style="width: 100%; height: 200px; object-fit: contain;"
                             onerror="this.style.display='none'" />
                    </div>

                    <h3 style="margin-top:0;">Your Receipt</h3>
                    <table class="receipt-table">
                        <thead><tr><th>Item</th><th>Qty</th><th>Price</th></tr></thead>
                        <tbody>
                            <tr>
                                <td><div class="receipt-item-name">@Model.ProductName</div></td>
                                <td id="summary-qty">1</td>
                                <td id="summary-subtotal">Tk. 0</td>
                            </tr>
                        </tbody>
                        <tfoot>
                            <tr><th colspan="2">Delivery</th><th id="receipt-delivery">Tk. 0</th></tr>
                            <tr class="grand-total"><th colspan="2">Total</th><th id="receipt-grand-total">Tk. 0</th></tr>
                        </tfoot>
                    </table>
                </div>

                <!-- PAYMENT METHOD SECTION (BELOW receipt on both mobile & desktop) -->
                <div class="payment-section">
                    <h3>Choose Payment Method</h3>

                    <div class="payment-options">
                        @{
                            var paymentMethods = ViewBag.PaymentMethods as List<MDUA.Entities.CompanyPaymentMethodResult>;
                            int cardCounter = 0; // Track actual rendered cards for selection logic
                        }

                        @if (paymentMethods != null && paymentMethods.Any())
                        {
                            for (int i = 0; i < paymentMethods.Count; i++)
                            {
                                var pm = paymentMethods[i];
                                bool hasRenderedAny = false;

                                // --- 1. MANUAL MODE CARD ---
                                if (pm.IsManualEnabled)
                                {
                                    var isHybrid = pm.GlobalSupportsGateway && pm.GlobalSupportsManual;
                                    var uniqueId = isHybrid ? $"{pm.SystemCode}_manual" : pm.SystemCode;
                                    var displayName = isHybrid ? $"{pm.MethodName} (Send Money)" : pm.MethodName;
                                    var isSelected = (cardCounter == 0);

                                    <div class="payment-option @(isSelected ? "selected" : "")"
                                         data-payment="@pm.SystemCode"
                                         data-mode="Manual">

                                        <input type="radio" name="paymentMethod" id="opt-@uniqueId" value="@uniqueId" @(isSelected ? "checked" : "")>

                                        <label for="opt-@uniqueId">
                                            <img src="@pm.LogoUrl" alt="@displayName" class="payment-logo"
                                                 style="@(pm.SystemCode == "card" ? "width: auto; height: 15px; margin-right: 5px;" : "")">
                                            <span>@displayName</span>
                                        </label>

                                        <input type="hidden" class="manual-instruction-text" value="@pm.CustomInstruction" />
                                    </div>

                                    hasRenderedAny = true;
                                    cardCounter++;
                                }

                                // --- 2. GATEWAY MODE CARD ---
                                if (pm.IsGatewayEnabled)
                                {
                                    var isHybrid = pm.GlobalSupportsGateway && pm.GlobalSupportsManual;
                                    var uniqueId = isHybrid ? $"{pm.SystemCode}_gateway" : pm.SystemCode;
                                    var displayName = isHybrid ? $"{pm.MethodName} (Secure Pay)" : pm.MethodName;
                                    var isSelected = (cardCounter == 0);

                                    <div class="payment-option @(isSelected ? "selected" : "")"
                                         data-payment="@pm.SystemCode"
                                         data-mode="Gateway">

                                        <input type="radio" name="paymentMethod" id="opt-@uniqueId" value="@uniqueId" @(isSelected ? "checked" : "")>

                                        <label for="opt-@uniqueId">
                                            <img src="@pm.LogoUrl" alt="@displayName" class="payment-logo"
                                                 style="@(pm.SystemCode == "card" ? "width: auto; height: 15px; margin-right: 5px;" : "")">

                                            @if (pm.SystemCode == "card")
                                            {
                                                <img src="https://upload.wikimedia.org/wikipedia/commons/2/2a/Mastercard-logo.svg" alt="Mastercard" class="payment-logo" style="width: auto; height: 20px;">
                                                <span style="margin-left: 10px;">@displayName</span>
                                            }
                                            else
                                            {
                                                <span>@displayName</span>
                                            }
                                        </label>
                                    </div>

                                    hasRenderedAny = true;
                                    cardCounter++;
                                }

                                // --- 3. FALLBACK: SIMPLE/OFFLINE CARD (Fix for COD) ---
                                // If it hasn't rendered as Manual or Gateway, but is Enabled (Active), show standard card.
                                if (!hasRenderedAny && pm.IsEnabled)
                                {
                                    var isSelected = (cardCounter == 0);
                                    <div class="payment-option @(isSelected ? "selected" : "")"
                                         data-payment="@pm.SystemCode"
                                         data-mode="Offline">
                                        <input type="radio" name="paymentMethod" id="opt-@pm.SystemCode" value="@pm.SystemCode" @(isSelected ? "checked" : "")>

                                        <label for="opt-@pm.SystemCode">
                                            <img src="@pm.LogoUrl" alt="@pm.MethodName" class="payment-logo">
                                            <span>@pm.MethodName</span>
                                        </label>
                                    </div>
                                    cardCounter++;
                                }
                            }
                        }
                        else
                        {
                            <div class="alert alert-warning text-center w-100">
                                No payment methods available.
                            </div>
                        }
                    </div>
                    <div id="payment-details-area" class="mt-3 p-3 border rounded bg-light" style="display:none;">
                        <div id="manual-payment-fields">
                            <div class="alert alert-info py-2 small mb-2">
                                <i class="fas fa-info-circle me-1"></i>
                                <span id="instruction-text"></span>
                            </div>

                            <label class="small fw-bold">Transaction ID (TrxID) <span class="text-danger">*</span></label>
                            <input type="text" name="TransactionReference" id="trx-id-input"
                                   class="form-control form-control-sm" placeholder="e.g. 8H7FA..." maxlength="20">
                        </div>
                    </div>

                    <button type="submit" class="submit-btn" id="final-submit-btn" form="order-form">
                        Confirm Order
                    </button>
                </div>
                @Html.Partial("_CustomerChatWidget")
            </div>
        </section>
    </div>

    <footer>
        <p>© @DateTime.Now.Year @(Model.CompanyName ?? "Combo King"). All Rights Reserved.</p>
    </footer>

    @Html.Partial("_OrderStatusModal")

    <script>
        const pricePerCombo = parseFloat(@(Model.SellingPrice));
        const deliveryCharges = {
            dhaka: @(Model.DeliveryCharges?.GetValueOrDefault("dhaka", 0) ?? 0),
            outside: @(Model.DeliveryCharges?.GetValueOrDefault("outside", 0) ?? 0)
        };
        window.baseProductInfo = {
            id: @Model.Id,
            price: pricePerCombo,
            image: "@FixPath(Model.Images?.FirstOrDefault(i => i.IsPrimary)?.ImageUrl ?? Model.Images?.FirstOrDefault()?.ImageUrl)"
        };

        // ✅ FIX 1 & 2: Removed leading comma and conflicting 'AvailableSizes' loop
        window.productVariants = [
            @if (Model.Variants != null)
            {
                foreach (var v in Model.Variants.Where(x => x.IsActive))
                {
                    var attrs = new Dictionary<string, string>();
                    // Only use Specifications to ensure 1:1 match with HTML buttons
                    if (Model.Specifications != null)
                    {
                        foreach (var spec in Model.Specifications)
                        {
                            foreach (var val in spec.Value)
                            {
                                if (v.VariantName != null && IsSafeMatch(v.VariantName, val))
                                {
                                    attrs[spec.Key] = val;
                                }
                            }
                        }
                    }

                    <text>,
                    {
                        id: @v.Id,
                        price: @(v.DiscountedPrice > 0 ? v.DiscountedPrice : (v.VariantPrice ?? Model.SellingPrice)),
                        stock: @v.StockQty,
                        image: "@FixPath(!string.IsNullOrEmpty(v.VariantImageUrl) ? v.VariantImageUrl : "")",
                        attributes: @Html.Raw(System.Text.Json.JsonSerializer.Serialize(attrs))
                    },
                    </text>
                }
            }
        ];

        // 1. Listen for the scroll event

        // 2. Define the function called by onclick="scrollToTop()"
        function scrollToTop() {
            window.scrollTo({
                top: 0,
                behavior: 'smooth'
            });
        }
    </script>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    @*   <environment include="Development">
        <script src="~/js/combo.js"></script>
    </environment> *@
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/6.0.1/signalr.js"></script>
    <script src="~/js/combo.js" asp-append-version="true"></script>
    <script src="~/js/order-track.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
</body>
</html>

@functions {
    public string FixPath(string path)
    {
        if (string.IsNullOrEmpty(path)) return "";
        string fixedPath = path.Replace("\\", "/");
        if (!fixedPath.StartsWith("/")) fixedPath = "/" + fixedPath;
        return fixedPath;
    }

    public bool IsSafeMatch(string text, string term)
    {
        if (string.IsNullOrEmpty(text) || string.IsNullOrEmpty(term)) return false;
        int index = -1;
        while ((index = text.IndexOf(term, index + 1, StringComparison.OrdinalIgnoreCase)) != -1)
        {
            bool startOk = (index == 0) || !char.IsLetterOrDigit(text[index - 1]);
            bool endOk = (index + term.Length == text.Length) || !char.IsLetterOrDigit(text[index + term.Length]);
            if (startOk && endOk) return true;
        }
        return false;
    }
    public string GetAttributeIcon(string name)
    {
        if (string.IsNullOrEmpty(name)) return "🔹";
        return name.ToLower().Trim() switch
        {
            "fabric" or "material" => "🧵",
            "size" or "dimension" => "📏",
            "color" or "colour" => "🎨",
            "weight" => "⚖️",
            "brand" => "🏷️",
            "warranty" => "🛡️",
            "storage" => "💾",
            "ram" or "memory" => "⚡",
            "battery" => "🔋",
            "display" or "screen" => "📱",
            _ => "✨"
        };
    }
    public string GetEmbedUrl(string url)
    {
        if (string.IsNullOrEmpty(url)) return "";

        // 1. Clean the custom aspect ratio tag so it doesn't break the player
        string cleanUrl = Regex.Replace(url, @"[&?]aspect=9:16", "", RegexOptions.IgnoreCase);

        // 2. Pass-through for valid embeds
        if (cleanUrl.Contains("/embed/") || cleanUrl.Contains("player.vimeo.com") || cleanUrl.Contains("facebook.com/plugins"))
        {
            return cleanUrl;
        }

        // 3. Converters
        var ytMatch = Regex.Match(cleanUrl, @"(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?|shorts)\/|.*[?&]v=)|youtu\.be\/)([^""&?\/\s]{11})", RegexOptions.IgnoreCase);
        if (ytMatch.Success) return $"https://www.youtube.com/embed/{ytMatch.Groups[1].Value}";

        var vimeoMatch = Regex.Match(cleanUrl, @"(?:vimeo\.com\/|player\.vimeo\.com\/video\/)(\d+)", RegexOptions.IgnoreCase);
        if (vimeoMatch.Success) return $"https://player.vimeo.com/video/{vimeoMatch.Groups[1].Value}";

        // 4. Facebook Logic
        if (cleanUrl.Contains("facebook.com") || cleanUrl.Contains("fb.watch"))
        {
            // Ensure https
            if (!cleanUrl.StartsWith("http")) cleanUrl = "https://" + cleanUrl;
            return $"https://www.facebook.com/plugins/video.php?href={System.Net.WebUtility.UrlEncode(cleanUrl)}&show_text=false&width=560";
        }

        return cleanUrl;
    }

    public bool IsVerticalVideo(string url)
    {
        if (string.IsNullOrEmpty(url)) return false;
        // Check for custom tag OR standard short keywords
        return Regex.IsMatch(url, @"aspect=9:16|\/reel\/|\/shorts\/", RegexOptions.IgnoreCase);
    }


}