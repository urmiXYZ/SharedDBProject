document.addEventListener("DOMContentLoaded",function(){const c=document.getElementById("requestModal"),l=document.getElementById("infoModal"),u=document.getElementById("receiveModal");[c,l,u].forEach(t=>{t&&t.parentNode!==document.body&&document.body.appendChild(t)});const m=new bootstrap.Modal(c),I=new bootstrap.Modal(l),y=new bootstrap.Modal(u);document.addEventListener("click",function(t){const o=t.target.closest(".btn-request");if(o){document.getElementById("reqVariantId").value=o.dataset.variantId,document.getElementById("reqProductName").value=o.dataset.name,document.getElementById("reqQty").value=o.dataset.suggested,m.show();return}const n=t.target.closest(".btn-receive");if(n){const d=n.dataset.variantId,s=n.dataset.name;document.getElementById("recVariantId").value=d,document.getElementById("recProductName").textContent=s,document.getElementById("recQty").value="",document.getElementById("recPrice").value="",document.getElementById("recInvoice").value="",document.getElementById("recRemarks").value="",document.getElementById("recReqQty").value="Loading...",y.show(),fetch(`/purchase/get-pending-info?variantId=${d}`).then(a=>a.json()).then(a=>{if(a.success&&a.data){const e=a.data.quantity;document.getElementById("recReqQty").value=e,document.getElementById("recQty").value=e}else document.getElementById("recReqQty").value="N/A"});return}const r=t.target.closest(".btn-req-info");if(r){const d=r.dataset.variantId,s=document.getElementById("infoModalBody");s.innerHTML='<div class="text-center text-muted py-5"><div class="spinner-border text-info"></div><div class="mt-2">Loading details...</div></div>',I.show(),fetch(`/purchase/get-pending-info?variantId=${d}`).then(a=>a.json()).then(a=>{if(a.success&&a.data){const e=a.data;s.innerHTML=`
                            <div class="list-group list-group-flush">
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request ID</span>
                                    <span class="fw-bold">PO #${e.id}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Vendor</span>
                                    <span class="fw-bold text-dark">${e.vendorName}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Requested Quantity</span>
                                    <span class="badge bg-warning text-dark fs-6">${e.quantity}</span>
                                </div>
                                <div class="list-group-item d-flex justify-content-between align-items-center p-3">
                                    <span class="text-muted">Request Date</span>
                                    <span>${e.requestDate}</span>
                                </div>
                                <div class="list-group-item p-3">
                                    <span class="text-muted d-block mb-2">Remarks</span>
                                    <div class="bg-light p-2 rounded border text-break text-secondary small">
                                        ${e.remarks||"No remarks provided."}
                                    </div>
                                </div>
                            </div>`}else s.innerHTML=`<div class="text-center text-danger py-4 p-3">${a.message||"Data not found"}</div>`}).catch(()=>{s.innerHTML='<div class="text-center text-danger py-4">Failed to load data.</div>'});return}});const p=document.getElementById("btnConfirmRequest");p&&p.addEventListener("click",function(){g("/purchase/create-request",{VendorId:parseInt(document.getElementById("reqVendor").value),ProductVariantId:parseInt(document.getElementById("reqVariantId").value),Quantity:parseInt(document.getElementById("reqQty").value)},this,m)});const f=document.getElementById("btnConfirmReceive");f&&f.addEventListener("click",function(){const t={ProductVariantId:parseInt(document.getElementById("recVariantId").value),Quantity:parseInt(document.getElementById("recQty").value),BuyingPrice:parseFloat(document.getElementById("recPrice").value),InvoiceNo:document.getElementById("recInvoice").value,Remarks:document.getElementById("recRemarks").value};if(!t.ProductVariantId||isNaN(t.ProductVariantId)){alert("System Error: Variant ID missing");return}if(!t.Quantity||t.Quantity<1){alert("Please enter a valid quantity.");return}if(isNaN(t.BuyingPrice)||t.BuyingPrice<0){alert("Please enter a valid total cost.");return}g("/purchase/receive-stock",t,this,y)});function g(t,o,n,r){const d=n.textContent;n.disabled=!0,n.textContent="Processing...";const s=document.querySelector('input[name="__RequestVerificationToken"]')?.value,a={"Content-Type":"application/json"};s&&(a.RequestVerificationToken=s),fetch(t,{method:"POST",headers:a,body:JSON.stringify(o)}).then(async e=>{const i=e.headers.get("content-type");if(i&&i.includes("application/json"))return await e.json();throw new Error("Invalid Server Response")}).then(e=>{if(e.success)r.hide(),o.ProductVariantId&&E(o.ProductVariantId),typeof Swal<"u"?Swal.mixin({toast:!0,position:"top-end",showConfirmButton:!1,timer:3e3,timerProgressBar:!0,didOpen:v=>{v.addEventListener("mouseenter",Swal.stopTimer),v.addEventListener("mouseleave",Swal.resumeTimer)}}).fire({icon:"success",title:e.message||"Success"}):alert(e.message||"Success!");else throw new Error(e.message||"Unknown Error")}).catch(e=>{typeof Swal<"u"?Swal.fire("Error",e.message,"error"):alert("Error: "+e.message)}).finally(()=>{n.disabled=!1,n.textContent=d})}function E(t){const o=document.getElementById(`row-${t}`);o&&(o.style.transition="opacity 0.3s",o.style.opacity="0.4",fetch(`/purchase/get-variant-row?variantId=${t}`).then(n=>n.text()).then(n=>{o.outerHTML=n;const r=document.getElementById(`row-${t}`);r&&(r.style.backgroundColor="#e8f5e9",setTimeout(()=>{r.style.backgroundColor=""},1e3)),h(t)}).catch(n=>console.error("Auto-refresh failed:",n)))}function h(t){const o=document.getElementById(`row-${t}`);if(!o)return;const n=o.closest(".collapse");if(!n)return;let r=0;n.querySelectorAll('[id^="stock-"]').forEach(a=>{const e=parseInt(a.textContent.trim())||0;r+=e});const s=document.querySelector(`button[data-bs-target="#${n.id}"]`);if(s){const e=s.closest("tr").querySelector(".group-total-stock");e&&(e.style.transition="color 0.3s",e.style.color="#198754",e.textContent=r,setTimeout(()=>{e.style.color=""},1e3))}}});
