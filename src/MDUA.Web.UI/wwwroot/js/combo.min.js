window.OrderAPI={checkCustomer:async function(o){try{const a=await fetch(`/order/check-customer?phone=${o}`);return a.ok?await a.json():{found:!1}}catch(a){return console.error("API Error:",a),{found:!1}}},checkPostalCode:async function(o){try{const a=await fetch(`/order/check-postal-code?code=${o}`);return a.ok?await a.json():{found:!1}}catch{return{found:!1}}},getDivisions:async function(){try{return await(await fetch("/order/get-divisions")).json()}catch{return[]}},getDistricts:async function(o){try{return await(await fetch(`/order/get-districts?division=${o}`)).json()}catch{return[]}},getThanas:async function(o){try{return await(await fetch(`/order/get-thanas?district=${o}`)).json()}catch{return[]}},getSubOffices:async function(o){try{return await(await fetch(`/order/get-suboffices?thana=${o}`)).json()}catch{return[]}}},$(document).ready(function(){if($("#order-form").length===0)return;$(".payment-option").on("click",function(){$(".payment-option").removeClass("selected"),$(this).addClass("selected"),$(this).find('input[type="radio"]').prop("checked",!0),o()});function o(){const e=$(".payment-option.selected");if(e.length===0)return;const t=e.data("mode"),i=e.find(".manual-instruction-text").val(),n=$("#payment-details-area"),r=$("#trx-id-input");t==="Manual"?(n.slideDown(200),$("#instruction-text").text(i||"Please follow the instructions."),r.prop("required",!0)):(n.slideUp(200),r.prop("required",!1).val("")),a()}function a(){const e=$(".payment-option.selected"),t=e.data("payment"),i=e.data("mode"),n=$("#receipt-grand-total").text(),r=$("#final-submit-btn");t==="cod"?r.text("Confirm Order (Cash on Delivery)"):i==="Manual"?r.text("Verify & Confirm Order"):r.text(`Pay ${n} Now`)}o();const u=x;x=function(){u(),a()};const T=window.baseProductInfo||{price:0,image:"/images/default-product.jpg"};let f=T.price,c=0,v={},C=!1,w=!1,g=null;const P=typeof deliveryCharges<"u"?deliveryCharges:{dhaka:0,outside:0},S=T.image;$("#display-price").text("Tk. "+f.toLocaleString()),$("#summary-subtotal").text("Tk. "+f.toLocaleString());function M(e,t){let i;return function(){const n=this,r=arguments;clearTimeout(i),i=setTimeout(()=>e.apply(n,r),t)}}const k=window.productVariants||[];if(k.length===1){const e=k[0];l(e),$(".variant-chip").addClass("selected"),e.attributes&&(v={...e.attributes})}$(document).on("click",".variant-chip",function(){let e=$(this),t=e.data("attribute"),i=e.data("value");e.hasClass("selected")?(e.removeClass("selected"),delete v[t]):($(`.variant-chip[data-attribute='${t}']`).removeClass("selected"),e.addClass("selected"),v[t]=i),I(),s()});function I(){$(".variant-chip").each(function(){const e=$(this),t=e.data("attribute"),i=e.data("value");if(e.hasClass("selected")){e.removeClass("disabled");return}const n={...v};delete n[t],n[t]=i,k.some(O=>{for(const[D,q]of Object.entries(n))if(!O.attributes||O.attributes[D]!==q)return!1;return!0})?e.removeClass("disabled"):e.addClass("disabled")})}I();function s(){$("#selected-variant-id").val("");const e=k.find(t=>{const i=Object.keys(t.attributes),n=Object.keys(v);if(i.length!==n.length)return!1;for(let r of n)if(!t.attributes.hasOwnProperty(r)||t.attributes[r]!==v[r])return!1;return!0});e?Object.keys(v).length>0?l(e):m():p()}function l(e){$("#selected-variant-id").val(e.id),f=e.price,$("#display-price").text("Tk. "+f.toLocaleString()),c=e.stock;let t=parseInt($("#quantity").val())||1;c>0&&t>c&&$("#quantity").val(c),A(c);let i=e.image&&e.image.length>1?e.image:S;!i.startsWith("/")&&!i.startsWith("http")&&(i="/"+i),$("#order-variant-image").attr("src",i),$("#mobile-order-variant-image").attr("src",i),$(".variant-chips-container").css("border","none"),x(),!C&&!$("#email-status").is(":visible")&&$(".submit-btn").prop("disabled",!1)}function m(){f=T.price,$("#display-price").text("Tk. "+f.toLocaleString()),$("#order-variant-image").attr("src",S),$("#mobile-order-variant-image").attr("src",S),$("#selected-variant-id").val(""),c=0,v={},$(".variant-chip").removeClass("selected"),I(),$("#variant-info").hide(),A(0),x()}function p(){$("#stock-message").text("This combination is currently unavailable.").addClass("text-danger show"),$("#order-variant-image").attr("src",S),$("#mobile-order-variant-image").attr("src",S),$("#selected-variant-id").val(""),c=0}function A(e){const t=$("#stock-message"),i=$("#variant-info");if(t.removeClass("stock-high stock-medium stock-low text-danger show text-success"),Object.keys(v).length===0&&k.length>1){i.hide();return}i.show(),e<=0?(t.text("Out of Stock").addClass("text-danger show"),$(".submit-btn").prop("disabled",!0).text("Out of Stock")):(t.text(`Current Stock: ${e} items available`).addClass("text-success show").css({"font-weight":"bold",color:"#10b981","font-size":"0.95rem"}),C||$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}function y(e){const t=$("#stock-error-message");t.text(e).addClass("show"),setTimeout(()=>{t.removeClass("show")},3e3)}function B(){$("#stock-error-message").text("").removeClass("show")}$("#customerEmail").on("input",function(){w=!1,$("#email-status").hide(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")}),$("#customerEmail").on("blur",function(){const e=$(this).val().trim(),t=$("#email-status");if(t.hide().removeClass("text-danger").removeClass("text-success"),!e){$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(w&&e===g){t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}if(!e.includes("@")){t.text("\u26A0 Please enter a valid email address").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order");return}C=!0,t.text("\u23F3 Checking email...").css("color","blue").show(),$(".submit-btn").prop("disabled",!0).text("Verifying..."),$.get("/order/check-email",{email:e},function(i){C=!1,i.exists?g&&e===g?(t.text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):(t.text("\u26A0 This email is already registered with a different phone number.").css("color","red").show(),$(".submit-btn").prop("disabled",!0).text("Fix Email")):(t.text("\u2713 Email available").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order"))}).fail(function(){C=!1,t.text("\u26A0 Could not verify email, but you can proceed.").css("color","orange").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")})}),$("#customerPhone").on("input",M(function(){let e=$(this).val();e.length>=11?($("#phone-status").text("\u23F3 Checking...").css("color","blue"),window.OrderAPI.checkCustomer(e).then(function(t){if(t.found)if($("#phone-status").text("\u2713 Welcome back! Info loaded.").css("color","green"),t.name&&$("#customerName").val(t.name),t.email){const i=$("#customerEmail"),n=i.val().trim();!n||n.includes("@guest.local")?(w=!0,g=t.email,i.val(t.email),$("#email-status").text("\u2713 Using your registered email").css("color","green").show(),$(".submit-btn").prop("disabled",!1).text("Confirm Order")):g=t.email}else g=null;else $("#phone-status").text("New Customer").css("color","#666"),w=!1,g=null}).catch(function(){$("#phone-status").text("\u26A0 Could not verify phone").css("color","orange")})):($("#phone-status").text(""),w=!1,g=null)},500));function b(e,t){$(e).empty().append(`<option value="">${t}</option>`).prop("disabled",!0)}function N(e,t,i){let n=$(e);if(n.empty().append(`<option value="">${i}</option>`),!t||t.length===0){n.append('<option value="" disabled>No options available</option>'),n.prop("disabled",!1);return}t.forEach(r=>{let O=r.name||r.Name||r,D=r.name||r.Name||r,q=r.code||r.Code||"";n.append(`<option value="${O}" data-code="${q}">${D}</option>`)}),n.prop("disabled",!1)}function j(){$.get("/order/get-divisions",function(e){N("#division-select",e,"Select Division")}).fail(function(){$("#division-select").append("<option>Error loading data</option>")})}j(),$("#division-select").change(function(){let e=$(this).val();b("#district-select","Loading..."),b("#thana-select","Select District first"),b("#suboffice-select","Select Thana first"),e?$.get("/order/get-districts",{division:e},function(t){N("#district-select",t,"Select District")}).fail(function(){b("#district-select","Error loading districts"),$("#district-select").prop("disabled",!1)}):b("#district-select","Select Division first")}),$("#district-select").change(function(){let e=$(this).val();b("#thana-select","Loading..."),b("#suboffice-select","Select Thana first");let t=P.outside;e&&(e.toLowerCase().includes("dhaka")||e.trim()==="Dhaka")&&(t=P.dhaka),$("#receipt-delivery").text("Tk. "+t).data("cost",t),x(),e?$.get("/order/get-thanas",{district:e},function(i){N("#thana-select",i,"Select Thana")}).fail(function(){b("#thana-select","Error loading thanas"),$("#thana-select").prop("disabled",!1)}):b("#thana-select","Select District first")}),$("#thana-select").change(function(){let e=$(this).val();b("#suboffice-select","Loading..."),e?$.get("/order/get-suboffices",{thana:e},function(t){N("#suboffice-select",t,"Select Sub-Office")}).fail(function(){b("#suboffice-select","Error loading sub-offices"),$("#suboffice-select").prop("disabled",!1)}):b("#suboffice-select","Select Thana first")}),$("#suboffice-select").change(function(){let e=$(this).find(":selected").data("code");e&&$('input[name="PostalCode"]').val()!=e&&$('input[name="PostalCode"]').val(e).css("border-color","#2ecc71")});function x(){let e=parseInt($("#quantity").val())||1,t=f*e,i=parseFloat($("#receipt-delivery").data("cost"))||0,n=t+i;$("#summary-qty").text(e),$("#summary-subtotal").text("Tk. "+t.toLocaleString()),$("#receipt-grand-total").text("Tk. "+n.toLocaleString())}$("#increase").click(function(e){e.preventDefault(),B();let t=parseInt($("#quantity").val())||1,i=$("#selected-variant-id").val();if(k.length===0){t<99?($("#quantity").val(t+1),$("#summary-qty").text(t+1),x()):y("Maximum quantity: 99 items");return}if(!i){y("\u26A0\uFE0F Please select product options first"),$(".variant-chips-container").css({border:"2px solid #ff6b6b",padding:"10px","border-radius":"8px"}),setTimeout(()=>{$(".variant-chips-container").css("border","none")},2e3);return}c>0?t<c?($("#quantity").val(t+1),$("#summary-qty").text(t+1),x()):(y(`Maximum available: ${c} items`),$("#quantity").val(c)):y("This item is currently out of stock")}),$("#decrease").click(function(e){e.preventDefault(),B();let t=parseInt($("#quantity").val())||1;t>1?($("#quantity").val(t-1),$("#summary-qty").text(t-1),x()):y("Minimum quantity is 1")}),$("#quantity").on("input change",function(){let e=parseInt($(this).val())||1;if($(this).val(e),e<1){$(this).val(1),y("Minimum quantity is 1");return}if(c>0&&e>c){$(this).val(c),y(`Maximum available: ${c} items`);return}if(e>99){$(this).val(99),y("Maximum quantity: 99 items");return}$("#summary-qty").text(e),x()}),$("#quantity").on("keypress",function(e){(e.which<48||e.which>57)&&e.preventDefault()}),$("#order-form").submit(function(e){if(e.preventDefault(),$(".input-error").removeClass("input-error"),$(".variant-chips-container").css({border:"none",padding:"0"}),C){Swal.fire({title:"Please wait",text:"Validating email address...",icon:"info",timer:1500,showConfirmButton:!1});return}const t=$("#email-status");if(t.is(":visible")&&t.css("color")==="rgb(255, 0, 0)"){$("html, body").animate({scrollTop:$("#customerEmail").offset().top-120},300),$("#customerEmail").focus();return}let i=!0,n=null;if($("#selected-variant-id").val()||(i=!1,$(".variant-chips-container").css({border:"2px solid #dc3545",padding:"5px","border-radius":"5px"}),n=$(".variant-selection-area")),$(this).find("input[required], select[required], textarea[required]").filter(":visible").each(function(){$(this).prop("disabled")||(!$(this).val()||$(this).val().trim()==="")&&(i=!1,$(this).addClass("input-error"),n||(n=$(this)))}),!i||n){if(n&&n.length){const d=n[0].getBoundingClientRect().top+window.scrollY;$("html, body").animate({scrollTop:d-120},600)}return}let r=parseInt($("#quantity").val());if(c>0&&r>c){$("#stock-error-message").text("ERROR: Requested quantity exceeds limit.");return}const O=$(".payment-option.selected"),D=O.data("payment"),q=O.data("mode");if(q==="Manual"&&!$("#trx-id-input").val().trim()){Swal.fire("Required","Please enter the Transaction ID (TrxID).","warning"),$("#trx-id-input").focus().addClass("input-error");return}let h={};$(this).serializeArray().forEach(d=>h[d.name]=d.value),h.PaymentMethod=D,h.PaymentMode=q,q==="Manual"&&(h.TransactionReference=$("#trx-id-input").val()),h.TargetCompanyId=1,h.ProductVariantId=parseInt(h.ProductVariantId),h.OrderQuantity=parseInt(h.OrderQuantity);let E=$("#final-submit-btn");E.prop("disabled",!0),h.PaymentMode==="Gateway"?E.text("Redirecting..."):E.text("Processing..."),$.ajax({url:"/order/place",type:"POST",contentType:"application/json",data:JSON.stringify(h),success:function(d){d.success?h.PaymentMethod==="cod"||h.PaymentMode==="Manual"?Swal.fire({title:"Success!",text:"Order Placed Successfully! Order ID: "+(d.orderId||"Check DB"),icon:"success",confirmButtonText:"OK",confirmButtonColor:"#2563eb"}).then(R=>{location.reload()}):d.paymentUrl?window.location.href=d.paymentUrl:Swal.fire({title:"Payment Pending",text:"Order created. Redirecting to payment...",icon:"info",confirmButtonText:"OK"}).then(()=>{location.reload()}):(Swal.fire({title:"Order Failed",text:d.message||"Failed to place order.",icon:"error",confirmButtonText:"Try Again"}),E.prop("disabled",!1),a())},error:function(d){let R="Network Error.";d.responseJSON&&d.responseJSON.message?R=d.responseJSON.message:d.responseText&&(R=d.responseText.substring(0,200)),Swal.fire({title:"Server Error",text:R,icon:"error",confirmButtonText:"Close"}),E.prop("disabled",!1),a()}})});let U=0;window.changeSlide=function(e){const t=document.querySelectorAll(".slide");t.length!==0&&(t[U].classList.remove("active"),U=(U+e+t.length)%t.length,t[U].classList.add("active"))};const V=document.querySelectorAll(".slide");V.length>0&&V[0].classList.add("active")}),$('input[name="PostalCode"]').on("input keyup blur",function(){let o=$(this).val().trim();if(o.length===4){let a=$(this);a.css("border-color","#3498db"),$.get("/order/check-postal-code",{code:o},function(u){u.found?(a.css("border-color","#2ecc71"),$("#division-select").val(u.division).trigger("change"),setTimeout(()=>{$("#district-select").val(u.district).trigger("change")},500),setTimeout(()=>{if(u.thana&&$("#thana-select").empty().append(`<option value="${u.thana}" selected>${u.thana}</option>`).prop("disabled",!1),u.subOffice){let f=$("#suboffice-select");f.empty().append(`<option value="${u.subOffice}" selected>${u.subOffice}</option>`),f.find(":selected").data("code",o),f.prop("disabled",!1)}},800)):a.css("border-color","#e74c3c")})}}),$(document).ready(function(){let o=null,a=localStorage.getItem("chatSessionId"),u=localStorage.getItem("chatUserName"),T=localStorage.getItem("chatSessionTimestamp");const f=3600*1e3;function c(){const s=new Date().getTime();T&&s-T>f&&(console.log("\u26A0\uFE0F Session expired. Starting fresh."),localStorage.removeItem("chatSessionId"),localStorage.removeItem("chatUserName"),localStorage.removeItem("chatSessionTimestamp"),a=null,u=null)}c(),a||(a=v(),localStorage.setItem("chatSessionId",a),localStorage.setItem("chatSessionTimestamp",new Date().getTime()));function v(){var s=new Date().getTime(),l=typeof performance<"u"&&performance.now&&performance.now()*1e3||0;return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(m){var p=Math.random()*16;return s>0?(p=(s+p)%16|0,s=Math.floor(s/16)):(p=(l+p)%16|0,l=Math.floor(l/16)),(m==="x"?p:p&3|8).toString(16)})}function C(){$.get("/chat/guest-history?sessionGuid="+a,function(s){s&&s.length>0&&(s.forEach(function(l){let m=l.isFromAdmin?"incoming":"outgoing",p=l.isFromAdmin?l.senderName||"Support":"You";g(p,l.messageText,m)}),u||I())})}C();function w(){o||(o=new signalR.HubConnectionBuilder().withUrl("/supportHub?sessionId="+a).withAutomaticReconnect().build(),o.on("ReceiveReply",function(s,l){localStorage.setItem("chatSessionTimestamp",new Date().getTime());var m=document.getElementById("chat-notification-sound");m&&m.play().catch(p=>console.log("Audio blocked")),g(s,l,"incoming"),$("#live-chat-box").is(":visible")||$("#support-widget-btn").addClass("active")}),o.on("ReceiveSystemMessage",function(s){const l=`<div class="msg-system">${s}</div>`;$("#chat-messages-list").append(l),P()}),o.start().then(()=>console.log("\u2705 Customer Chat Connected")).catch(s=>console.error(s)))}w();function g(s,l,m){const p=$("#chat-messages-list");let A=m==="incoming"?`<div class="msg-sender-name">${s}</div>`:"";const y=`
            <div class="msg-${m}">
                ${A}
                <div class="msg-bubble">${l}</div>
            </div>`;p.append(y),P()}function P(){const s=document.getElementById("chat-body");s&&(s.scrollTop=s.scrollHeight)}function S(){const s=$("#chat-input-field").val().trim(),l=u||"Guest";s&&(localStorage.setItem("chatSessionTimestamp",new Date().getTime()),g("You",s,"outgoing"),$("#chat-input-field").val(""),o&&o.invoke("SendMessageToAdmin",l,s,a).catch(m=>console.error(m)))}$("#chat-send-btn").click(S),$("#chat-input-field").keypress(function(s){s.which==13&&S()}),$("#support-widget-btn").click(function(){$(this).toggleClass("active");const s=$("#support-options"),l=$(this).find("i");s.hasClass("show")?(s.removeClass("show"),$("#live-chat-box").fadeOut(),l.removeClass("fa-times").addClass("fa-headset")):(s.addClass("show"),$("#live-chat-box").hide(),l.removeClass("fa-headset").addClass("fa-times"))}),$("#btn-open-live-chat").click(function(){$("#support-options").removeClass("show");const s=$("#support-widget-btn");s.addClass("active"),s.find("i").removeClass("fa-headset").addClass("fa-times"),$("#live-chat-box").fadeIn().css("display","flex"),k()}),$("#chat-close-btn").click(function(){$("#live-chat-box").fadeOut();const s=$("#support-widget-btn");s.removeClass("active"),s.find("i").removeClass("fa-times").addClass("fa-headset")}),$("#chat-start-btn").click(function(){const s=$("#chat-guest-name").val().trim();s?M(s):$("#chat-guest-name").css("border-color","red")}),$("#chat-skip-btn").click(function(){M("Guest")});function M(s){u=s,localStorage.setItem("chatUserName",s),I(),localStorage.setItem("chatSessionTimestamp",new Date().getTime())}function k(){u?(I(),setTimeout(()=>$("#chat-input-field").focus(),300)):($("#chat-name-screen").css("display","flex"),$("#chat-messages-list").hide(),$("#chat-footer").css("display","none"))}function I(){$("#chat-name-screen").hide(),$("#chat-messages-list").css("display","flex"),$("#chat-footer").css("display","flex")}a&&w()});
