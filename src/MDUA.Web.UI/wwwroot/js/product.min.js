$(document).ready(function(){let p=$("#addProductModal #attributes-container .attribute-row").length;function w(t){return t.reduce((e,a)=>e.flatMap(l=>a.map(o=>l.concat([o]))),[[]])}function d(){let t=[];$("#addProductModal .attribute-select").each(function(){let e=$(this).val();e&&t.push(e)}),$("#addProductModal .attribute-select").each(function(){let e=$(this).val();$(this).find("option").each(function(){let a=$(this).val();a&&(t.includes(a)&&a!==e?$(this).prop("disabled",!0):$(this).prop("disabled",!1))})})}$("#addProductModal").on("click","#add-attribute",function(){let t=$("#addProductModal #attributes-container .attribute-row:first-child select"),e=t.length?t.html():'<option value="">-- Select Attribute --</option>',a=`
            <div class="attribute-row mb-2" data-attr-index="${p}">
                <select name="Attributes[${p}].AttributeId" 
                        class="attribute-select form-control-modal form-select form-select-sm">
                    ${e}
                </select>
                <div class="attribute-values-container mt-2"></div>
                <button type="button" 
                    class="btn btn-sm btn-outline-danger remove-attribute mt-1">x</button>
            </div>
        `;$("#addProductModal #attributes-container").append(a),p++,d()}),$("#addProductModal").on("click",".remove-attribute",function(){$(this).closest(".attribute-row").remove(),d(),c()}),$("#addProductModal").on("change",".attribute-select",function(){let t=$(this),a=t.closest(".attribute-row").find(".attribute-values-container"),l=t.val();if(a.empty(),!l){d();return}a.html('<div class="text-muted small fst-italic">Loading values...</div>');let o=window.productConfig&&window.productConfig.urls?window.productConfig.urls.getAttributeValues:"/Product/GetAttributeValues";$.ajax({url:o,type:"GET",data:{attributeId:l},success:function(i){if(a.empty(),!i||i.length===0){a.html('<span class="text-muted small">No values found.</span>');return}i.forEach(n=>{let s=n.id||n.Id,f=n.value||n.Value||n.name||n.Name;a.append(`
                    <div class="form-check">
                        <input type="checkbox" 
                               class="form-check-input attribute-value-checkbox" 
                               id="attr_val_${s}_${Date.now()}"
                               value="${s}" 
                               data-attrname="${f}" />
                        <label class="form-check-label" for="attr_val_${s}_${Date.now()}">
                            ${f}
                        </label>
                    </div>
                `)}),d()},error:function(i,n,s){console.error("Error loading attributes:",s),a.html('<span class="text-danger small">Error loading data.</span>')}})}),$("#addProductModal").on("change",".attribute-value-checkbox",c);function c(){let t=$("#addProductModal #variants-container");t.html("");let e=[];if($("#addProductModal .attribute-row").each(function(){let i=$(this).find(".attribute-value-checkbox:checked");if(i.length>0){let n=[];i.each(function(){n.push({id:$(this).val(),label:$(this).data("attrname")})}),e.push(n)}}),e.length===0)return;let a=w(e),l=$("input[name='ProductName']").val()||"",o=$("#addProductModal input[name='BasePrice']").val()||0;a.length>0&&t.append(`
                <div class="variant-header-row mb-1 d-flex">
                    <span class="w-50" style="font-weight: bold;">Variant Name</span>
                    <span class="w-50" style="font-weight: bold;">Variant Price</span>
                </div>
            `),a.forEach((i,n)=>{let s=l+" - "+i.map(b=>b.label).join(" - "),f=i.map((b,y)=>`<input type="hidden" name="Variants[${n}].AttributeValueIds[${y}]" value="${b.id}" />`).join("");t.append(`
                <div class="variant-row mb-2 d-flex align-items-center">
                    ${f}
                    <input type="hidden" name="Variants[${n}].VariantName" value="${s}" />
                    
                    <span class="w-50 small">${s}</span>
                    
                    <div class="w-50 d-flex align-items-center">
                        <span class="me-1 small">Tk.</span> 
                        <input type="number" 
                               name="Variants[${n}].VariantPrice"
                               class="form-control form-control-sm form-control-modal" style="width: 100px;" 
                               value="${o}"
                               required />
                        
                        <button type="button" class="btn btn-sm btn-outline-danger remove-variant ms-2" 
                                style="line-height: 1; padding: 0.25rem 0.5rem;">&times;</button>
                    </div>
                </div>
            `)})}$("#addProductModal input[name='ProductName']").on("input",function(){c()}),$("#addProductModal").on("click",".remove-variant",function(){$(this).closest(".variant-row").remove();let t=$("#addProductModal #variants-container .variant-row");t.each(function(e){$(this).find("input").each(function(){let l=$(this),o=l.attr("name");if(o){let i=o.replace(/^(Variants\[)\d+/,`$1${e}`);l.attr("name",i)}})}),t.length===0&&$("#addProductModal #variants-container .variant-header-row").remove()}),$("#addProductModal").on("hidden.bs.modal",function(){let t=$(this).find("form");t[0].reset(),t.find(".attribute-row:not(:first)").remove(),t.find(".attribute-values-container").html(""),t.find("#variants-container").html(""),d(),$("#slugInput").removeClass("is-valid is-invalid"),$("#slug-error").hide(),$("#btn-save-product").prop("disabled",!1).text("Create Product")}),$("#addProductModal").on("keydown","input",function(t){(t.key==="Enter"||t.keyCode===13)&&t.preventDefault()}),$("form").on("submit",function(t){document.querySelectorAll('select[name^="Attributes"]').forEach(a=>{a.value||(a.disabled=!0)})});const P=$('input[name="ProductName"]'),r=$("#slugInput"),v=$("#slug-error"),u=$("#btn-save-product");let m,h=!1;function g(t){t&&(r.addClass("loading-slug"),$.get("/product/check-slug",{slug:t}).done(function(e){r.removeClass("loading-slug"),e.exists?(r.addClass("is-invalid").removeClass("is-valid"),v.show(),u.prop("disabled",!0),u.text("Fix Slug Error")):(r.removeClass("is-invalid").addClass("is-valid"),v.hide(),u.prop("disabled",!1),u.text("Create Product"))}).fail(function(){r.removeClass("loading-slug")}))}r.on("input",function(){const t=$(this).val().trim();t!==""&&(h=!0),r.removeClass("is-valid is-invalid"),v.hide(),u.prop("disabled",!1),clearTimeout(m),t&&(m=setTimeout(()=>g(t),500))}),P.on("input",function(){if(c(),!h){const e=$(this).val().toLowerCase().replace(/[^a-z0-9\s-]/g,"").trim().replace(/\s+/g,"-").replace(/-+/g,"-");r.val(e),clearTimeout(m),e&&(m=setTimeout(()=>g(e),500))}})});
