document.addEventListener("DOMContentLoaded",function(){console.log("Admin Order Script Loaded");const L=document.getElementById("productSelect"),l=document.getElementById("variantSelect"),P=document.getElementById("orderQty"),T=document.getElementById("displayPrice"),M=document.getElementById("displaySubTotal"),V=document.getElementById("displayDiscount"),B=document.getElementById("displayDelivery"),F=document.getElementById("displayNet"),y=document.getElementById("stockInfo"),A=document.getElementById("modeDelivery"),E=document.getElementById("modeStore"),c=document.getElementById("division-select"),x=document.getElementById("district-select"),v=document.getElementById("thana-select"),g=document.getElementById("suboffice-select"),w=document.getElementById("postalCode"),I=document.getElementById("postalStatus");let C=!1;if(typeof window.OrderAPI>"u"){console.error("OrderAPI is missing! Make sure combo.js is loaded before admin-order.js");return}const j=typeof window.rawVariants<"u"&&Array.isArray(window.rawVariants)?window.rawVariants:[],k={};j.forEach(t=>{const e=t.ProductId||t.productId,s=t.ProductName||t.productName;if(e){if(!k[e]){k[e]={name:s,variants:[]};let d=new Option(s,e);L.add(d)}k[e].variants.push(t)}}),L.addEventListener("change",function(){l.innerHTML='<option value="" data-price="0">Select Variant...</option>',l.disabled=!0,y.textContent="",r();const t=this.value;t&&k[t]&&(k[t].variants.forEach(e=>{const s=e.VariantId||e.variantId,d=e.VariantName||e.variantName,o=e.Price||e.price,n=parseInt(e.Stock||e.stock||0),i=e.DiscountType||e.discountType||"None",m=e.DiscountValue||e.discountValue||0;let b=`${d} (Tk. ${o})`,h=n<=0;h?b+=" \u274C":n<10&&n!==999&&(b+=` (${n} left)`);let f=new Option(b,s);f.setAttribute("data-price",o),f.setAttribute("data-stock",n),f.setAttribute("data-disc-type",i),f.setAttribute("data-disc-val",m),h&&(f.disabled=!0,f.style.color="#dc3545",f.style.fontWeight="bold"),l.add(f)}),l.disabled=!1)}),l.addEventListener("change",function(){const t=this.options[this.selectedIndex],e=parseInt(t.getAttribute("data-stock"))||0;e===999?(y.textContent="In Stock",y.className="form-text text-success"):e<=0?(y.textContent="Out of Stock",y.className="form-text text-danger fw-bold"):(y.textContent=`Available: ${e}`,y.className=e<5?"form-text text-danger fw-bold":"form-text text-success"),r()}),P.addEventListener("input",r),c&&c.addEventListener("change",r),A&&A.addEventListener("change",r),E&&E.addEventListener("change",r);function r(){if(l.selectedIndex<0)return;const t=l.options[l.selectedIndex],e=parseFloat(t.getAttribute("data-price"))||0,s=parseInt(P.value)||1,d=t.getAttribute("data-disc-type"),o=parseFloat(t.getAttribute("data-disc-val"))||0,n=e*s;let i=0;d==="Flat"?i=o*s:d==="Percentage"&&(i=n*(o/100));let m=0;if(!E.checked){const h=c.value?c.value.toLowerCase():"";h.includes("dhaka")?m=50:h!==""&&(m=100)}const b=n-i+m;T.textContent=e.toFixed(2),M.textContent=n.toFixed(2),V.textContent=i.toFixed(2),B&&(B.textContent=m.toFixed(2)),F.textContent=b.toFixed(2)}async function u(t,e,s=null){e.innerHTML='<option value="">Loading...</option>',e.disabled=!0;try{const d=await t;e.innerHTML='<option value="">Select...</option>',Array.isArray(d)&&(d.forEach(o=>{let n=o.name||o,i=new Option(n,n);(o.code||o.postalCode)&&i.setAttribute("data-code",o.code||o.postalCode),e.add(i)}),e.disabled=!1,s&&(e.value=s))}catch{e.innerHTML='<option value="">Error</option>'}}u(window.OrderAPI.getDivisions(),c),c.addEventListener("change",()=>{u(window.OrderAPI.getDistricts(c.value),x).then(()=>{v.innerHTML='<option value="">Select...</option>',v.disabled=!0,g.innerHTML='<option value="">Select...</option>',g.disabled=!0,r()})}),x.addEventListener("change",()=>{u(window.OrderAPI.getThanas(x.value),v)}),v.addEventListener("change",()=>{u(window.OrderAPI.getSubOffices(v.value),g)}),g.addEventListener("change",function(){const t=this.options[this.selectedIndex].getAttribute("data-code");t&&(w.value=t,C=!0,I.textContent="Auto-filled",I.className="text-success small")}),w.addEventListener("blur",function(){const t=this.value.trim();if(t.length<4){C=!1;return}I.textContent="Checking...",window.OrderAPI.checkPostalCode(t).then(async e=>{if(e.found){C=!0,I.textContent="Location found!",I.className="text-success small";const s=e.division||e.DivisionEn,d=e.district||e.DistrictEn,o=e.thana||e.ThanaEn,n=e.subOffice||e.SubOfficeEn;s&&(c.value=s,r(),await u(window.OrderAPI.getDistricts(s),x,d),await u(window.OrderAPI.getThanas(d),v,o),await u(window.OrderAPI.getSubOffices(o),g,n))}else C=!1,I.textContent="Invalid Code",I.className="text-danger small"})});const O=document.getElementById("custAddress"),S=document.getElementById("custPhone"),H=document.getElementById("address-container"),p=document.getElementById("custEmail"),a=document.getElementById("custEmailStatus");let N="";p&&p.addEventListener("blur",function(){const t=this.value.trim();if(a&&(a.textContent=""),!(!t||!t.includes("@"))){if(t===N){a&&(a.textContent="\u2713 Verified existing email",a.className="d-block mt-1 text-success small");return}fetch(`/order/check-email?email=${encodeURIComponent(t)}`).then(e=>e.json()).then(e=>{a&&(e.exists?(a.textContent="\u26A0 This email is already registered to another customer!",a.className="d-block mt-1 text-danger fw-bold small"):(a.textContent="\u2713 Email available",a.className="d-block mt-1 text-success small"))})}});function D(){H.style.display=E.checked?"none":"block",r()}A.addEventListener("change",D),E.addEventListener("change",D),document.getElementById("btnCheckCust").addEventListener("click",()=>{const t=S.value.trim();t.length<10||window.OrderAPI.checkCustomer(t).then(e=>{if(e.found){if(document.getElementById("custName").value=e.name||"",p&&(p.value=e.email||"",N=e.email||""),document.getElementById("custStatus").textContent="Customer found!",document.getElementById("custStatus").className="text-success small",e.addressData&&A.checked){if(O.value=e.addressData.street||"",e.addressData.postalCode)w.value=e.addressData.postalCode,w.dispatchEvent(new Event("blur"));else if(e.addressData.divison){const s=e.addressData.divison,d=e.addressData.city,o=e.addressData.thana,n=e.addressData.subOffice;c.value=s,r(),d&&u(window.OrderAPI.getDistricts(s),x,d).then(()=>{if(o)return u(window.OrderAPI.getThanas(d),v,o)}).then(()=>{if(n)return u(window.OrderAPI.getSubOffices(o),g,n)})}}}else document.getElementById("custStatus").textContent="New Customer",document.getElementById("custStatus").className="text-primary small",document.getElementById("custName").value="",p&&(p.value="",N=""),O.value=""})}),document.getElementById("btnPlaceOrder").addEventListener("click",function(){const t=this,e=document.getElementById("orderMsg"),s=E.checked;if(!S.value||!document.getElementById("custName").value||!l.value){alert("Please fill in Phone, Name, Product, and Variant.");return}if(!s){if(!O.value||!c.value){alert("Address and Division are required for Home Delivery.");return}if(!C){alert("Please verify Postal Code before submitting.");return}}if(a&&a.className.includes("text-danger")){alert("Please use a different email address."),p.focus();return}const d={CustomerPhone:S.value,CustomerName:document.getElementById("custName").value,CustomerEmail:p?p.value:"",Street:s?"Counter Sale - In Store":O.value,Divison:s?"Dhaka":c.value,City:s?"Dhaka":x.value,Thana:s?"":v.value,SubOffice:s?"":g.value,PostalCode:s?"1000":w.value||"0000",ProductVariantId:parseInt(l.value),OrderQuantity:parseInt(P.value),TargetCompanyId:parseInt(document.getElementById("targetCompanyId")?.value)||1,Confirmed:document.getElementById("confirmImmediately").checked},o=document.querySelector('input[name="__RequestVerificationToken"]').value;t.disabled=!0,t.textContent="Processing...",e&&(e.textContent=""),fetch("/order/place-direct",{method:"POST",headers:{"Content-Type":"application/json",RequestVerificationToken:o},body:JSON.stringify(d)}).then(n=>n.json()).then(n=>{if(n.success){let i=n.orderId,m=0;typeof n.orderId=="object"&&n.orderId!==null?(m=n.orderId.NetAmount||n.orderId.netAmount,i=n.orderId.OrderId||n.orderId.orderId):n.netAmount&&(m=n.netAmount);const b=parseFloat(B.textContent)||0,h=(parseFloat(m)||0)+b,f=`
                <div class="modal fade" id="successModal" tabindex="-1" aria-hidden="true" data-bs-backdrop="static" data-bs-keyboard="false">
                  <div class="modal-dialog modal-dialog-centered">
                    <div class="modal-content border-0 shadow-lg">
                      <div class="modal-body text-center p-5">
                        <div class="mb-3" style="font-size: 4rem;">\u{1F389}</div>
                        <h2 class="fw-bold text-success mb-2">Order Placed!</h2>
                        <p class="text-muted mb-4">The direct order has been created successfully.</p>
                        
                        <div class="card bg-light border-0 p-3 mb-4">
                            <h4 class="fw-bold text-dark m-0">${i}</h4>
                            <div class="d-flex justify-content-between mt-3 border-top pt-2">
                                <span class="fw-bold">Grand Total (Inc. Delivery):</span>
                                <span class="fw-bold text-primary fs-5">Tk. ${h.toFixed(2)}</span>
                            </div>
                        </div>

                        <div class="d-grid gap-2 d-sm-flex justify-content-sm-center">
                            <button type="button" class="btn btn-outline-secondary px-4" onclick="window.location.reload()">Create Another</button>
<button type="button" 
        class="btn btn-primary px-4" 
        onclick="window.location.href='/order/all'">
    View Orders List
</button>                        </div>
                      </div>
                    </div>
                  </div>
                </div>`;document.body.insertAdjacentHTML("beforeend",f),new bootstrap.Modal(document.getElementById("successModal")).show()}else e&&(e.textContent="Error: "+n.message,e.className="text-danger small mt-2"),t.disabled=!1,t.textContent="Create Direct Order"}).catch(n=>{e&&(e.textContent="Network Error",e.className="text-danger small mt-2"),t.disabled=!1,t.textContent="Create Direct Order"})}),D()});
