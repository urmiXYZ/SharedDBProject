var adminChat=(function(){var o=null;function h(){console.log("Initializing Admin Chat..."),o=new signalR.HubConnectionBuilder().withUrl("/supportHub").withAutomaticReconnect().build(),o.start().then(()=>console.log("\u2705 Admin Chat SignalR Connected")).catch(e=>console.error(e)),o.on("ReceiveMessage",function(e,t,n){l(),$("#admin-chat-panel").is(":visible")&&c();var a=$("#current-chat-guid").val();a&&a.toLowerCase()===n.toLowerCase()&&u(e,t,!1)}),l(),f()}function f(){$("#header-msg-btn").off("click").on("click",function(e){e.stopPropagation(),$("#header-msg-dropdown").toggle(),$("#header-msg-dropdown").is(":visible")&&l()}),$(document).on("click",function(){$("#header-msg-dropdown").hide()}),$("#header-msg-dropdown").on("click",function(e){e.stopPropagation()}),$("#admin-send-btn").off("click").on("click",g),$("#admin-chat-input").off("keypress").on("keypress",function(e){e.which==13&&g()})}function l(){$.get("/chat/active-sessions",function(e){const t=$("#header-chat-list");t.empty();let n=0;if(!e||e.length===0){t.append('<div class="text-center p-4 text-muted small">No active conversations.</div>'),$("#header-msg-badge").hide();return}e.forEach(function(i){n+=i.unreadCount||0;let r=i.unreadCount>0?"background-color: #f0f9ff;":"background-color: #fff;",d=i.unreadCount>0?"font-weight: 800; color: #000;":"font-weight: 600; color: #334155;",p=i.unreadCount>0?`<span class="badge bg-primary rounded-pill ms-2">${i.unreadCount}</span>`:"",s=i.unreadCount>0?'<span class="text-primary fw-bold">New messages</span>':'<span class="text-muted">Click to view</span>',x=(i.guestName||"Gu").substring(0,2).toUpperCase(),y=new Date(i.lastMessageAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),w=`
                <div onclick="adminChat.openFromHeader('${i.id}', '${i.sessionGuid}', '${i.guestName}')"
                     style="padding: 12px 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; display: flex; align-items: center; gap: 12px; transition:0.2s; ${r}">
                    <div style="width: 40px; height: 40px; background: #e2e8f0; color: #475569; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold;">${x}</div>
                    <div style="flex:1; min-width:0;">
                        <div class="d-flex justify-content-between align-items-center mb-1">
                            <span class="text-truncate" style="font-size:0.9rem; ${d}">${i.guestName} ${p}</span>
                            <span class="text-muted" style="font-size:0.7rem;">${y}</span>
                        </div>
                        <div class="text-truncate small" style="font-size:0.75rem;">${s}</div>
                    </div>
                </div>`;t.append(w)});const a=$("#header-msg-badge");n>0?(a.text(n).show(),$("#header-msg-btn i").removeClass("text-secondary").addClass("text-primary")):(a.hide(),$("#header-msg-btn i").removeClass("text-primary").addClass("text-secondary"))})}function c(){$.get("/chat/active-sessions",function(e){if($("#admin-chat-list").empty(),!e||e.length===0){$("#admin-chat-list").append('<div style="padding:15px; color:#666; text-align:center;">No active chats</div>');return}e.forEach(function(t){let n=new Date(t.lastMessageAt).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),a=t.id==$("#current-chat-session-id").val()?"background-color: #e0f2fe;":"",i=t.unreadCount>0?'<span style="width:8px; height:8px; background:red; border-radius:50%; display:inline-block; margin-right:5px;"></span>':"",r=`
                    <div onclick="adminChat.openSession('${t.id}', '${t.sessionGuid}', '${t.guestName}')"
                         style="padding: 15px; border-bottom: 1px solid #f1f5f9; cursor: pointer; transition: background 0.2s; ${a}"
                         onmouseover="this.style.background='#f1f5f9'" onmouseout="this.style.background='${a?"#e0f2fe":"transparent"}'">
                        <div style="font-weight: 600; color: #334155; margin-bottom: 4px;">${i} ${t.guestName}</div>
                        <div style="font-size: 0.8rem; color: #64748b; display: flex; justify-content: space-between;">
                            <span>${t.status}</span><span>${n}</span>
                        </div>
                    </div>`;$("#admin-chat-list").append(r)})})}function m(e,t,n){$("#current-chat-session-id").val(e),$("#current-chat-guid").val(t),$("#chat-current-guest").text(n),$("#admin-chat-history").html('<div style="text-align:center; padding:20px;">Loading history...</div>'),setTimeout(function(){l(),$("#admin-chat-panel").is(":visible")&&c()},1e3);var a=$("#current-admin-name").val()||"Admin",i="Support Agent - "+a;o&&o.state===signalR.HubConnectionState.Connected&&o.invoke("AdminJoinSession",i,t),$.get("/chat/history?sessionId="+e,function(r){$("#admin-chat-history").empty(),r.forEach(d=>u(d.senderName,d.messageText,d.isFromAdmin))})}function v(e,t,n){$("#header-msg-dropdown").hide(),$("#admin-chat-panel").fadeIn(),m(e,t,n)}function g(){const e=$("#admin-chat-input").val().trim(),t=$("#current-chat-guid").val();var n=$("#current-admin-name").val()||"Admin";!e||!t||o.invoke("SendReplyToUser",n,e,t).then(function(){u(n,e,!0),$("#admin-chat-input").val("")})}function u(e,t,n){let a=n?"align-self: flex-end;":"align-self: flex-start;",i=n?"background: #2563eb; color: white;":"background: #f1f5f9; color: #1e293b;",r=n?"border-radius: 12px 12px 0 12px;":"border-radius: 12px 12px 12px 0;",d=n?`Sent by ${e}`:e,p=`<div style="${a} max-width: 70%; ${i} padding: 10px 14px; ${r} font-size: 0.95rem; line-height: 1.5; margin-bottom: 5px;">${t}</div>
                    <div style="${a} font-size: 0.7rem; color: #94a3b8; margin-bottom: 8px;">${d}</div>`,s=$("#admin-chat-history");s.length>0&&(s.append(p),s.scrollTop(s[0].scrollHeight))}function b(){$("#admin-chat-panel").toggle(),$("#admin-chat-panel").is(":visible")&&c()}return{init:h,openSession:m,openFromHeader:v,refreshActive:c,togglePanel:b}})();$(document).ready(function(){adminChat.init()});
