window.openAdvanceModal=function(f){const i=f,r=i.getAttribute("data-order-ref"),E=i.getAttribute("data-cust-id"),a=parseFloat(i.getAttribute("data-net"))||0,l=parseFloat(i.getAttribute("data-paid"))||0,m=(f.getAttribute("data-city")||"").toLowerCase();document.getElementById("adv_orderRef").value=r,document.getElementById("adv_customerId").value=E,document.getElementById("adv_netAmount").value=a,document.getElementById("adv_alreadyPaid").value=l,document.getElementById("adv_displayPaid").textContent=l.toFixed(2);let v=window.deliveryConfig.outside;m&&m.includes("dhaka")&&(v=window.deliveryConfig.dhaka),document.getElementById("adv_delivery").value=v,document.getElementById("adv_paidAmount").value="",document.getElementById("adv_note").value="";const d=document.getElementById("adv_paymentType");d&&(d.value="Advance");const u=document.getElementById("adv_paidAmount"),y=document.getElementById("adv_submitBtn");u.classList.remove("is-invalid"),y&&(y.disabled=!1);const e=new Event("input");document.getElementById("adv_delivery").dispatchEvent(e);const t=document.getElementById("advanceModal");t.parentElement!==document.body&&document.body.appendChild(t),new bootstrap.Modal(t).show()},document.addEventListener("DOMContentLoaded",function(){document.querySelectorAll(".confirm-toggle").forEach(e=>{e.addEventListener("change",function(){const t=this,c=t.getAttribute("data-id"),n=t.checked,p=document.getElementById(`status-badge-${c}`),s=t.nextElementSibling;s&&(s.textContent=n?"Yes":"No");const g=new URLSearchParams;g.append("id",c),g.append("isConfirmed",n);const I=document.querySelector('input[name="__RequestVerificationToken"]')?.value;fetch("/SalesOrder/ToggleConfirmation",{method:"POST",headers:{"Content-Type":"application/x-www-form-urlencoded",RequestVerificationToken:I},body:g.toString()}).then(o=>o.json()).then(o=>{o.success&&p?(p.textContent=o.newStatus,p.className=o.newStatus==="Confirmed"?"badge bg-success text-white":"badge bg-warning text-dark"):o.success||(t.checked=!n,alert("Action failed: "+o.message))}).catch(o=>{t.checked=!n,alert("Network error.")})})});const i=document.getElementById("adv_netAmount"),r=document.getElementById("adv_delivery"),E=document.getElementById("adv_alreadyPaid"),a=document.getElementById("adv_paidAmount"),l=document.getElementById("adv_submitBtn"),m=document.getElementById("adv_displayCurrentDue"),v=document.getElementById("adv_dueAmount"),d=document.getElementById("adv_paymentType");function u(){const e=parseFloat(i.value)||0,t=parseFloat(r.value)||0,c=parseFloat(E.value)||0,n=parseFloat(a.value)||0,s=e+t-c,g=s-n;return m&&(m.textContent=s.toFixed(2)),v&&(v.textContent=g.toFixed(2)),n>s+.01?(a.classList.add("is-invalid"),l&&(l.disabled=!0)):(a.classList.remove("is-invalid"),l&&(l.disabled=!1)),{currentDue:s,payingNow:n}}a&&a.addEventListener("input",function(){const{currentDue:e,payingNow:t}=u();d&&t<=e&&(t>=e&&e>0?d.value="Sale":d.value="Advance")}),r&&r.addEventListener("input",function(){if(u(),d&&d.value==="Sale"){const e=new Event("change");d.dispatchEvent(e)}}),d&&d.addEventListener("change",function(){const{currentDue:e}=u();this.value==="Sale"?a.value=e>0?e:0:a.value="",u()});const y=document.getElementById("advanceForm");y&&y.addEventListener("submit",function(e){e.preventDefault();const t=parseFloat(document.getElementById("adv_delivery").value)||0,c={CustomerId:parseInt(document.getElementById("adv_customerId").value),PaymentMethodId:parseInt(document.getElementById("adv_paymentMethod").value),PaymentType:document.getElementById("adv_paymentType").value,Amount:parseFloat(document.getElementById("adv_paidAmount").value),TransactionReference:document.getElementById("adv_orderRef").value,Notes:document.getElementById("adv_note").value,DeliveryCharge:t};fetch("/order/add-payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}).then(n=>n.json()).then(n=>{n.success?(alert("Saved Successfully!"),location.reload()):alert("Error: "+n.message)}).catch(n=>alert("Network Error"))})});
