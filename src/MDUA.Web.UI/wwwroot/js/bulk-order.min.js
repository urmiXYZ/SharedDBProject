document.addEventListener("DOMContentLoaded",function(){console.log("\u2705 Bulk Order Script Loaded");let s=null,d=null;document.body.addEventListener("click",function(t){const e=t.target.closest(".js-btn-details");if(e){t.preventDefault();const n=e.getAttribute("data-order-id");u(n)}});function u(t){console.log(`\u{1F50D} Opening details for Order ID: ${t}`),s=t;const e=document.getElementById("detailsModal"),n=document.getElementById("modalContentPlaceholder");if(!e||!n){console.error("\u274C Modal elements not found!");return}e.parentElement!==document.body&&document.body.appendChild(e),d&&(d.dispose(),d=null),d=new bootstrap.Modal(e,{backdrop:"static",keyboard:!1}),n.innerHTML=`
            <div class="d-flex flex-column align-items-center justify-content-center py-5">
                <div class="spinner-border text-primary" role="status"></div>
                <span class="mt-2 text-muted">Loading details...</span>
            </div>`,d.show(),fetch(`/Purchase/GetBulkOrderDetails?id=${t}`).then(o=>{if(!o.ok)throw new Error("Network response was not ok");return o.text()}).then(o=>{n.innerHTML=o}).catch(o=>{console.error(o),n.innerHTML='<div class="alert alert-danger m-3">Error loading data.</div>'})}window.addEventListener("beforeunload",function(){document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove())});const m=document.getElementById("bulkOrderForm");m&&m.addEventListener("submit",function(t){console.log("--- FORM SUBMISSION STARTED ---"),document.querySelectorAll(".variant-checkbox:checked").length===0&&(alert("Please select at least one item."),t.preventDefault())}),document.querySelectorAll(".product-checkbox").forEach(t=>{t.addEventListener("change",function(){const e=this.id;document.querySelectorAll(`.variant-checkbox[data-parent="${e}"]`).forEach(o=>{o.checked=this.checked})})}),document.querySelectorAll(".variant-checkbox").forEach(t=>{t.addEventListener("change",function(){const e=this.dataset.parent,n=document.getElementById(e),o=document.querySelectorAll(`.variant-checkbox[data-parent="${e}"]`),r=Array.from(o).every(i=>i.checked),c=Array.from(o).some(i=>i.checked);n.checked=r,n.indeterminate=c&&!r})}),document.body.addEventListener("click",function(t){const e=t.target.closest(".js-btn-receive-toggle");if(e){t.preventDefault();const n=e.getAttribute("data-target"),o=document.getElementById(n),r=e.parentElement;o&&(o.classList.remove("d-none"),r.classList.add("d-none"))}}),document.body.addEventListener("click",function(t){const e=t.target.closest(".js-btn-cancel-receive");if(e){t.preventDefault(),console.log("Cancel button clicked");const n=e.getAttribute("data-target"),o=document.getElementById(n),r=n.split("-")[1],c=document.getElementById(`btn-group-${r}`);o?o.classList.add("d-none"):console.error("Form row not found:",n),c?c.classList.remove("d-none"):console.error("Button group not found: btn-group-"+r)}}),document.body.addEventListener("click",function(t){const e=t.target.closest(".js-btn-confirm-receive");if(e){t.preventDefault();const n=e.closest("tr"),o=parseInt(e.getAttribute("data-variantid")),r=parseInt(e.getAttribute("data-poid")),c=parseInt(e.getAttribute("data-max-qty")),i=n.querySelector(".js-input-qty"),l=parseInt(i.value),p=n.querySelector(".js-input-price").value,b=n.querySelector(".js-input-invoice").value,h=n.querySelector(".js-input-remarks").value;if(!l||l<=0){alert("Please enter a valid Quantity.");return}if(l>c){alert(`You cannot receive more than the ordered quantity (${c}).`);return}if(!p||parseFloat(p)<0){alert("Please enter a valid Buying Price.");return}const g={ProductVariantId:o,Quantity:l,BuyingPrice:parseFloat(p),InvoiceNo:b,Remarks:h},f=e.innerText;e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm"></span>',fetch("/purchase/receive-stock",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g)}).then(a=>a.json()).then(a=>{a.success?s&&u(s):(alert(a.message),e.disabled=!1,e.innerText=f)}).catch(a=>{console.error(a),alert("An error occurred while connecting to the server."),e.disabled=!1,e.innerText=f})}}),document.body.addEventListener("click",function(t){const e=t.target.closest(".js-btn-reject");if(e){if(t.preventDefault(),!confirm("Are you sure you want to REJECT this item? This cannot be undone."))return;const n=parseInt(e.getAttribute("data-poid")),o=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm"></span>',fetch("/purchase/reject-item",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({PoRequestId:n})}).then(r=>r.json()).then(r=>{r.success?s&&u(s):(alert(r.message),e.disabled=!1,e.innerHTML=o)}).catch(r=>{console.error(r),alert("Error rejecting item."),e.disabled=!1,e.innerHTML=o})}})});
