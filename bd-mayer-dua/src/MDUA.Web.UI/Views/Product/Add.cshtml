@model dynamic
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Add Product";
}

<div class="d-flex justify-content-between align-items-center mb-4">
    <div>
        <h2 class="fw-bold mb-0">Add Product</h2>
        <div class="text-muted small">Create a new item in your catalog</div>
    </div>
    <a href="@Url.Action("AllProducts", "Product")" class="btn btn-outline-secondary btn-sm rounded-pill px-3">
        &larr; Back to List
    </a>
</div>

<!-- CRITICAL: id="addProductModal" wraps the whole form for JS compatibility -->
<div id="addProductModal">
    <form method="post" asp-controller="Product" asp-action="AddProduct">
        @Html.AntiForgeryToken()

        <div class="row g-4">
            <!-- LEFT COLUMN: Main Information -->
            <div class="col-lg-8">
                <div class="glass-card p-4 h-100">
                    <h6 class="text-uppercase text-muted small fw-bold mb-4 border-bottom pb-2">Product Details</h6>

                    <!-- Product Name -->
                    <div class="mb-4">
                        <label class="form-label fw-bold small">Product Name</label>
                        <input type="text" name="ProductName" class="form-control form-control-modal" placeholder="e.g. Premium T-Shirt" required />
                    </div>

                    <!-- Description -->
                    <div class="mb-4">
                        <label class="form-label fw-bold small">Description</label>
                        <textarea name="Description" class="form-control form-control-modal" rows="6" placeholder="Enter full product description..."></textarea>
                    </div>

                    <!-- Pricing & Inventory Grid -->
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Base Price</label>
                            <div class="input-group">
                                <span class="input-group-text bg-light border-end-0">Tk</span>
                                <input type="number" step="0.01" name="BasePrice" class="form-control form-control-modal border-start-0 ps-0" placeholder="0.00" required />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label class="form-label fw-bold small">Reorder Level</label>
                            <input type="number" name="ReorderLevel" class="form-control form-control-modal" value="0" required />
                        </div>
                        <div class="col-12">
                            <label class="form-label fw-bold small">Slug (Unique URL)</label>
                            <input type="text" name="Slug" class="form-control form-control-modal" placeholder="product-name-slug" required />
                            <div class="form-text small">Leave empty to auto-generate from name.</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- RIGHT COLUMN: Settings, Attributes & Actions -->
            <div class="col-lg-4">
                <div class="glass-card p-4 position-sticky" style="top: 1rem;">

                    <!-- Status & Category -->
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Configuration</h6>

                    <div class="bg-light p-3 rounded border mb-3">
                        <div class="form-check">
                            <input type="checkbox" name="IsActive" value="true" class="form-check-input" id="IsActive" checked />
                            <input type="hidden" name="IsActive" value="false" />
                            <label class="form-check-label fw-bold" for="IsActive">Active</label>
                            <div class="small text-muted" style="font-size: 0.75rem;">Visible on storefront</div>
                        </div>
                    </div>

                    <div class="mb-4">
                        <label class="form-label fw-bold small">Category</label>
                        <select name="CategoryId" class="form-select form-control-modal" required>
                            <option value="">-- Select Category --</option>
                            @if (Model.Categories != null)
                            {
                                foreach (var c in Model.Categories)
                                {
                                    <option value="@c.Id">@c.Name</option>
                                }
                            }
                        </select>
                    </div>

                    <hr class="border-light my-4" />

                    <!-- Attributes Section -->
                    <h6 class="text-uppercase text-muted small fw-bold mb-3">Attributes & Variants</h6>

                    <div id="attributes-container" class="mb-2">
                        <div class="attribute-row mb-2" data-attr-index="0">
                            <label class="small text-muted fw-bold mb-1">Add attribute</label>
                            <select name="Attributes[0].AttributeId" class="attribute-select form-select form-select-sm form-control-modal mb-2">
                                <option value="">-- Select Attribute --</option>
                                @if (Model.Attributes != null)
                                {
                                    foreach (var a in Model.Attributes)
                                    {
                                        <option value="@a.Id">@a.Name</option>
                                    }
                                }
                            </select>
                            <div class="attribute-values-container bg-white rounded border p-2 small"></div>
                        </div>
                    </div>

                    <button type="button" id="add-attribute" class="btn btn-sm btn-outline-secondary w-100 dashed-border mb-3">
                        + Add Another Attribute
                    </button>

                    <!-- Variants Container (Populated by JS) -->
                    <div id="variants-container" class="mt-3 small"></div>

                    <hr class="border-light my-4" />

                    <!-- Actions -->
                    <div class="d-grid gap-2">
                        <button type="submit" class="btn btn-danger fw-bold shadow-sm">Create Product</button>
                        <a href="@Url.Action("Dashboard", "Home")" class="btn btn-light text-muted">Cancel</a>
                    </div>
                </div>
            </div>
        </div>
    </form>
</div>

@section Scripts {
    <script>
        window.productConfig = {
            urls: {
                getAttributeValues: '@Url.Action("GetAttributeValues", "Product")',
                getVariantsPartial: '@Url.Action("GetVariantsPartial", "Product")',
                addSingleVariant: '@Url.Action("AddSingleVariant", "Product")',
                getMissingAttributes: '@Url.Action("GetMissingAttributes", "Product")',
                addAttributeToVariant: '@Url.Action("AddAttributeToVariant", "Product")'
            }
        };
    </script>
    <script src="~/js/product.js"></script>
}