@model MDUA.Entities.Product
@{
    ViewData["Title"] = Model.ProductName ?? "Combo Offer";
    Layout = null;

    // Extract dynamic data safely
    int dhakaCharge = Model.DeliveryCharges?.GetValueOrDefault("dhaka", 0) ?? 0;
    int outsideCharge = Model.DeliveryCharges?.GetValueOrDefault("outside", 0) ?? 0;
    decimal basePrice = Model.BasePrice ?? 0;
    var sizePriceMap = Model.Variants
    .Where(v => v.IsActive)
    .ToDictionary(
        v => v.VariantName.Split('-').Last().Trim(),  // Extract pure size
        v => v.VariantPrice ?? Model.SellingPrice     // Fallback if NULL
    );

}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>@Model.ProductName | @Model.CompanyName</title>
    <link rel="stylesheet" href="~/css/combo.css" />
</head>
<body>

    <header class="header">
        <img src="~/images/logo.jpg" alt="Combo King Logo" class="logo" />
    </header>

    <!-- 🔹 Product Hero -->
    <section class="combo-info">
        <h1>🎉 @Model.ProductName 🎉</h1>
        <p>@Model.Description</p>
        <a href="#order" class="btn combo-btn">Order Now</a>
    </section>

    <!-- 🔹 Stock / Scarcity -->
    <section class="scarcity-section">
        <p class="stock-text">@Model.ScarcityMessage</p>
        <div class="stock-bar">
            <div class="stock-fill" style="width:@Model.StockBarPercentage.ToString("0")%;"></div>
        </div>
        <p class="hurry-text">Hurry! Selling fast 🚀</p>
    </section>

    <!-- 🔹 Price -->
    <section class="price-section">
        <p class="price">
            Tk. @Model.SellingPrice.ToString("N0")
            <span class="old-price">Tk. @basePrice.ToString("N0")</span>
        </p>
        <p class="offer-text">💰 Cash on delivery available across Bangladesh</p>
    </section>

    <!-- 🔹 Main Product Image -->
    <section class="product-image">
        @{
            var mainImage = Model.Images?.FirstOrDefault(i => i.IsPrimary)
            ?? Model.Images?.FirstOrDefault();
        }

        @if (mainImage != null)
        {
            <img src="@Url.Content($"~{mainImage.ImageUrl}")"
                 alt="@Model.ProductName"
                 class="combo main-img"
                 loading="eager" />
        }
        else
        {
            <img src="~/images/default-product.jpg"
                 alt="No image available"
                 class="combo main-img" />
        }
    </section>

    <!-- 🔹 Product Gallery -->
    <section class="product-gallery">
        <h2>Product Gallery</h2>
        <div class="carousel">
            <button class="prev" onclick="changeSlide(-1)">&#10094;</button>

            <div class="slides">
                @if (Model.Images != null && Model.Images.Count > 0)
                {
                    // Exclude the main/primary image
                    var galleryImages = Model.Images
                    .Where(i => mainImage == null || i.ImageUrl != mainImage.ImageUrl)
                    .ToList();

                    if (galleryImages.Any())
                    {
                        foreach (var img in galleryImages)
                        {
                            <img src="@Url.Content($"~{img.ImageUrl}")"
                                 alt="@Model.ProductName Gallery"
                                 class="slide"
                                 loading="lazy" />
                        }
                    }
                    else
                    {
                        <img src="~/images/default-product.jpg"
                             alt="No gallery images"
                             class="slide" />
                    }
                }
                else
                {
                    <img src="~/images/default-product.jpg"
                         alt="No gallery images"
                         class="slide" />
                }
            </div>

            <button class="next" onclick="changeSlide(1)">&#10095;</button>
        </div>
    </section>



    <!-- 🔹 Description -->
    <section class="description">
        <h2>Product Details</h2>
        <div class="detail-row"><span class="detail-icon">🧵</span><p><strong>Fabric:</strong> 100% Cotton</p></div>
        <div class="detail-row"><span class="detail-icon">📏</span><p><strong>Sizes:</strong> @string.Join(", ", Model.AvailableSizes)</p></div>
        <div class="detail-row"><span class="detail-icon">🎨</span><p><strong>Colors:</strong> Random combo of 3 solid colors</p></div>
        <div class="detail-row"><span class="detail-icon">💰</span><p><strong>Price:</strong> Tk. @Model.SellingPrice.ToString("N0")</p></div>
    </section>

    <!-- 🔹 Reviews -->
    <section class="testimonials">
        <h2>What Our Customers Say</h2>
        <div class="reviews">
            @if (Model.Reviews != null && Model.Reviews.Count > 0)
            {
                foreach (var review in Model.Reviews)
                {
                    <div class="review">
                        <p class="review-text">"@review.ReviewText"</p>
                        <p class="reviewer">– @review.CustomerName</p>
                    </div>
                }
            }
            else
            {
                <p>No reviews yet.</p>
            }
        </div>
    </section>

    <!-- 🔹 Order Section -->
    <section id="order" class="order-section">
        <h2>Place Your Order</h2>
        <div class="order-container">
            <!-- Billing -->
            <div class="billing">
                <form id="order-form">
                    <label>Full Name:</label><input type="text" required />
                    <label>Phone Number:</label><input type="tel" required />
                    <label>Address:</label><textarea required></textarea>

                    <label>Select Size:</label>
                    <select id="size-select" required>
                        <option value="">Choose size</option>
                        @foreach (var size in Model.AvailableSizes)
                        {
                            <option value="@size">@size</option>
                        }
                    </select>

                    <label>Quantity:</label>
                    <div class="quantity-wrapper">
                        <button type="button" id="decrease">-</button>
                        <input type="number" id="quantity" value="1" min="1" readonly />
                        <button type="button" id="increase">+</button>
                    </div>

                    <label>Delivery Location:</label>
                    <select id="delivery-select" required>
                        <option value="dhaka">Dhaka (Tk. @dhakaCharge)</option>
                        <option value="outside">Outside Dhaka (Tk. @outsideCharge)</option>
                    </select>

                    <button type="submit" class="btn submit-btn">Confirm Order</button>
                </form>
            </div>

            <!-- Receipt -->
            <div class="order-summary">
                <h3>Your Receipt</h3>
                <table class="receipt-table">
                    <thead><tr><th>Product</th><th>Size</th><th>Qty</th><th>Price</th></tr></thead>
                    <tbody>
                        <tr>
                            <td>@Model.ProductName</td>
                            <td id="summary-size">M</td>
                            <td id="summary-qty">1</td>
                            <td id="summary-total">Tk. @Model.SellingPrice.ToString("N0")</td>
                        </tr>
                    </tbody>
                    <tfoot>
                        <tr><th colspan="3">Total</th><th id="receipt-total">Tk. @Model.SellingPrice.ToString("N0")</th></tr>
                    </tfoot>
                </table>
            </div>
        </div>
    </section>

    <footer>
        <p>© 2025 Combo King. All Rights Reserved.</p>
    </footer>

    <!-- Injected data for script -->
    <script>
        // server-provided data (ensure this is rendered as valid JSON)
        const variantPrices = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(sizePriceMap));
        const pricePerCombo = parseFloat(@Model.SellingPrice ?? 0);
        const deliveryCharges = {
            dhaka: @dhakaCharge,
            outside: @outsideCharge
        };
    </script>

    <script src="~/js/combo.js"></script>

</body>
</html>
